/*
 *  (c) 2000-2017 deviantART, Inc. All rights reserved.
 */
var rangeInNode=function(e,n){var t=e.commonAncestorContainer;do if(t==n)return!0;while(t=t.parentNode);return!1},getRangeForCaret=function(e){if(window.getSelection&&window.getSelection().rangeCount){var n=window.getSelection().getRangeAt(0);if(n.collapsed&&rangeInNode(n,e))return n.cloneRange()}},getWordFromRange=function(e){var n=e.startContainer,t=e.startOffset;return n.nodeType===Node.TEXT_NODE?n.nodeValue.substr(0,t).match(/[^\s>]*$/)[0]:""},expandRangeToWord=function(e){var n=getWordFromRange(e),t=e.startOffset;e.setStart(e.startContainer,t-n.length),e.setEnd(e.startContainer,t)};window.Carotid={getWord:function(e){if("INPUT"==e.nodeName)return e.value;var n=getRangeForCaret(e);return n?getWordFromRange(n):""},setWord:function(e,n){if("INPUT"==e.nodeName)return e.value=n,void 0;var t=getRangeForCaret(e);if(t){expandRangeToWord(t);var r=document.createTextNode(n),o=document.createElement("span");t.surroundContents(o),t.insertNode(r),o.parentNode.removeChild(o),t.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(t)}},setWordWithSpanWrapper:function(e,n,t,r){if("INPUT"==e.nodeName)return e.value=n,void 0;var o=getRangeForCaret(e);if(o){expandRangeToWord(o);var a=document.createTextNode(n),d=document.createTextNode(r),i=document.createElement("span"),g=document.createElement("span");g.appendChild(a),g.className=t,g.setAttribute("data-id",n),o.surroundContents(i),r&&o.insertNode(d),o.insertNode(g),i.parentNode.removeChild(i),o.collapse(!1);var u=window.getSelection();u.removeAllRanges(),u.addRange(o)}},getWordBoundingRect:function(e){if("INPUT"==e.nodeName)return e.getBoundingClientRect();var n=getRangeForCaret(e);return n?(expandRangeToWord(n),n.getBoundingClientRect()):void 0},getNode:function(e){if("INPUT"==e.nodeName)return e;var n=getRangeForCaret(e);return n?n.commonAncestorContainer:void 0}},window.DWait&&DWait.run("jms/lib/carotid.js");
DWait.ready(["jms/lib/ddt.js","jms/lib/carotid.js","jms/lib/bind.js","jms/lib/popup2.js","jms/lib/Base.js","jms/lib/difi.js","jms/lib/php.js","jms/lib/jquery/jquery.current.js","jms/lib/jquery/plugins/jquery.throttle-debounce.js"],function(){var t=function(t){for(var e=t;(e=e.parentNode)&&"visible"==$(e).css("overflow"););var s=$(t),i=$(e),o=$(e).scrollTop(),r=o+i.outerHeight(),n=t.offsetTop,a=n+s.outerHeight();o>n?i.scrollTop(n):a>r&&i.scrollTop(a-i.outerHeight())},e=function(t){var e=$(t).find(".user-symbol").data("gruser-type");if(!e)return"~";var s="~";return $.each(PHP.$GLOBALS.symbols,function(t,i){return i.userclass==e?(s=t,!1):void 0}),s},s=0;window.DAutoComplete=Base.extend({constructor:function(t,e,i){this.priority_values=e||[],this.options=$.extend({trailing_char:" ",exact_check:!1},i),this.$=$('<div class="dautocomplete"></div>').addClass(this.classes),this.popup=new Popup2("dautocomplete"+ ++s,"body",{content:this.$,classes:"dautocomplete",events:[{selector:".item",event:"mousedown",callback:this.mouseDown.bind(this)},{selector:".item",event:"mouseover",callback:this.mouseOver.bind(this)}]}),$("#output, #dv7, .bubbleview, .stash-container").on("scroll",$.throttle(50,function(){this.isShown()&&$("body").is(".ccwriter-subframe")&&this.show()}.bind(this))),this.watching=$(t).on("keydown.dauto",this.keyDown.bind(this)).on("keyup.dauto",this.keyUp.bind(this)).on("paste.dauto",this.show.bind(this)).on("writereditcomplete.dauto",this.show.bind(this))},destructor:function(){this.watching&&this.watching.off(".dauto")},completeStemFromWord:function(){return!1},show:function(){var t=Carotid.getNode(this.watching[0]);if(!t||$(t).closest("a").length)return this.hide();var e=Carotid.getWord(this.watching[0]);ddt.log("dautocomplete","Considering showing",e);var s=this.completeStemFromWord(e);return s?(this.$.find(".selected").removeClass("selected"),this.$.find(".item:first").addClass("selected"),this.renderHTML(s),void 0):(ddt.log("dautocomplete","not showing","no stem",e),this.hide())},position:function(){this.isShown()||this.popup.show({top:0,left:0});var t=Carotid.getWordBoundingRect(this.watching[0]),e={left:t.left+window.pageXOffset-document.documentElement.clientLeft,top:t.bottom+window.pageYOffset-document.documentElement.clientTop},s=this.$.width()||200,i=this.$.height()||300;e.left+s>$(document).width()&&(e.left-=s),e.top+i>$(document).height()&&(e.top-=i+t.height+10),ddt.log("dautocomplete","Showing",this.last_word,t,e),this.popup.show(e)},hide:function(){ddt.log("dautocomplete","Hiding"),this.last_word=!1,this.check_delay=clearTimeout(this.check_delay),this.popup.hide()},isShown:function(){return this.popup.visible()},confirm:function(){this.watching.trigger("dautocompleted"),this.hide()},outputText:function(t){this.options.trailing_char&&(t+=this.options.trailing_char),Carotid.setWord(this.watching[0],t)},keyDown:function(e){switch(e.which){case 27:this.isShown()&&(e.preventDefault(),this.hide());break;case 37:case 39:this.isShown()&&this.hide();break;case 38:case 40:if(this.isShown()){var s;1===this.$.find(".item").length?(this.$.find(".item").addClass("selected"),this.$.find(".selected").addClass("selected")):(s=this.$.find(".selected")[38==e.keyCode?"prev":"next"](),s.length&&(this.$.find(".selected").removeClass("selected"),s.addClass("selected"),t(s[0]))),e.preventDefault()}break;case 32:this.hide();break;case 13:case 10:case 9:this.isShown()&&(this.confirm(),this.hide(),e.stopImmediatePropagation(),e.preventDefault())}},keyUp:function(t){switch(t.which){case 39:case 37:case 38:case 40:case 13:case 10:case 9:case 27:case 91:case 93:case 16:case 17:case 18:return;default:this.show()}},fetch:function(){return $.Deferred()},renderHTML:function(t,e){var s=[],i=this;t=t.toLowerCase(),t!==this.last_word&&(this.check_delay=clearTimeout(this.check_delay)),this.last_word=t;var o;e||(o=this.fetch(t).done(function(){if(i.isShown()){if(t!==i.last_word)return ddt.log("dautocomplete","fetch done","not showing",t,i.last_word),void 0;i.renderHTML(t,!0),t&&i.possiblyValid(t)&&void 0===i.data_store[t]&&(i.check_delay=setTimeout(function(){i.check_delay=void 0,i.isShown()&&i.fetch(t,!0).done(function(){i.data_store[t]&&(i.data_store[t].low_priority=!0),i.isShown()&&t===i.last_word&&i.renderHTML(t,!0)})},600))}}));for(var r=this.keysForWord(t),n=0;r.length>n;n++)s.push(this.renderItem(this.data_store[r[n]]));if((this.check_delay||o&&"resolved"!==o.state())&&s.push('<div class="'+(s.length?"":"noresults ")+'loading">Searching...</div>'),0===s.length){if(!this.not_found_message)return ddt.log("dautocomplete","not showing","no results, no searching, no message",t),this.hide();s.push('<div class="noresults">'+this.not_found_message+"</div>"),ddt.log("dautocomplete","not not showing",s,e)}this.$.html(s.join("")),this.$.find(".selected").removeClass("selected");var a=this.options.hasOwnProperty("select_first_item")?this.options.select_first_item:!0;a&&this.$.find(".item:first").addClass("selected"),setTimeout(function(){t==i.last_word&&i.position()},1)},keysForWord:function(t){var e=this,s=[],i=RegExp("^"+t,"i");return $.each(this.data_store,function(t,e){e&&i.test(t)&&s.push(t)}),s.sort(function(s,i){var o=$.inArray(s,e.priority_values),r=$.inArray(i,e.priority_values);return o>-1&&r>-1?o-r:o>-1&&-1==r?-1:r>-1&&-1==o?1:(s=s.toLowerCase(),i=i.toLowerCase(),e.data_store[s].low_priority?1:e.data_store[i].low_priority?-1:s==t.toLowerCase()?1:i==t.toLowerCase()?-1:i>s?-1:s>i?1:0)}),s},mouseOver:function(t){return this.$.find(".selected").removeClass("selected"),$(t.target).closest(".item").addClass("selected"),!1},mouseDown:function(t){return 1===t.which&&(this.confirm(),t.preventDefault()),!1},renderItem:function(){return'<div class="item">UNIMPLEMENTED</div>'}}),window.DAutoCompleteUsers=DAutoComplete.extend({data_store:{},classes:"dautocomplete-users",not_found_message:"No deviants found",letters_fetched:{},possiblyValid:function(t){return!!(t||"").match(/^[a-z0-9\-]{3,20}$/i)},completeStemFromWord:function(t){var e;if(this.options.noat)e=t;else{if("@"!==t[0])return!1;e=t.substr(1)}return this.possiblyValid(e)?e:!1},fetch:function(t){var s=$.Deferred(),i=this,o=[];this.first_user_fetch||(this.first_user_fetch=!0,$(".username-with-symbol").filter(function(){return!$(this).closest("#depths").length}).each(function(){var t=$(".username",this).text().toLowerCase();if(i.possiblyValid(t)&&!i.data_store[t]){var s=e(this),r=$('.avatar[title="'+t+'"]').attr("src");r||o.push(t),i.data_store[t]={markup:PHP.userlink(t,s),username:t,iconurl:r}}})),void 0===i.data_store[t]&&this.options.exact_check&&(i.data_store[t]=!1,o.push(t));var r=[],n=$.Deferred();o.length?DiFi.pushPost("User","getDetailsByUsername",[o],function(t,e){return t?($.each(e.response.content,function(t,e){i.data_store[t.toLowerCase()]={markup:e.link,iconurl:e.avatar,username:e.username}}),n.resolve(),void 0):n.resolve()}):n.resolve(),r.push(n);var a=t[0];if(window.deviantART.deviant.loggedIn&&a&&this.letters_fetched[a]!==!0){var d=$.Deferred();DiFi.pushPrivateGet("Friends","getFriendsForLetter",[a,this.letters_fetched[a]||0],function(e,s){return e?(i.letters_fetched[t[0]]=s.response.content.has_more?s.request.args[1]+1:!0,$.each(s.response.content.friends,function(t,e){i.data_store[e.username.toLowerCase()]={markup:PHP.userlink(e.username,e.symbol),username:e.username,iconurl:e.avatar}}),d.resolve(),void 0):d.resolve()}),this.letters_fetched[t[0]]=!0,r.push(d)}return $.when.apply($,r).then(function(){s.resolve(i.data_store)}),DiFi.send(),s},confirm:function(){var t=this.$.find(".selected .username").text();return t&&(this.options.noat||(t="@"+t),this.outputText(t)),this.base()},renderItem:function(t){return'<div class="item"><img width="20" height="20" src="'+(t.iconurl||"about:blank")+'"> '+t.markup+"</div>"}}),window.DAutoCompleteNoteUsers=DAutoCompleteUsers.extend({type:!1,completeStemFromWord:function(t){var e=t;if(this.options.query_editor){if(e&&!e.match(/^(from|to):/))return!1;this.type=e.match(/^from:/)?"from":"to",e=e.replace(/^(from|to):/,"")}return this.possiblyValid(e)?e:!1},show:function(){var t=Carotid.getNode(this.watching[0]);if(!t||$(t).closest("a").length)return this.watching.trigger("dautocomplete.nothing"),this.hide();var e=Carotid.getWord(this.watching[0]);ddt.log("dautocomplete","Considering showing",e);var s=this.completeStemFromWord(e);return s?(this.$.find(".selected").removeClass("selected"),this.$.find(".item:first").addClass("selected"),this.renderHTML(s),void 0):(ddt.log("dautocomplete","not showing","no stem",e),this.watching.trigger("dautocomplete.nothing"),this.hide())},hide:function(){ddt.log("dautocomplete","Hiding"),this.last_word=!1,this.popup.hide()},confirm:function(){var t=this.$.find(".selected .username").text();t&&(this.options.query_editor?this.outputText(this.type+":"+t):this.outputText(t),this.watching.trigger("dautocompleted",[this.type+":"+t])),this.hide()},outputText:function(t){return this.options.query_editor?(Carotid.setWordWithSpanWrapper(this.watching[0],t,"filter",this.options.trailing_char),range=document.createRange(),range.selectNodeContents(this.watching[0]),range.collapse(!1),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range),void 0):this.base(t)},mouseDown:function(t){return this.watching.trigger("dautocomplete.clicked"),1===t.which&&(this.confirm(),t.preventDefault()),!1}}),window.DAutoCompleteTags=DAutoComplete.extend({data_store:{},classes:"dautocomplete-tags",possiblyValid:function(t){if(!/^(\w|[^\u0000-\u007F])+$/.test(t))return!1;if(3>t.length)return!1;var e=t.replace(/[\u00A0-\u2666]/g,function(t){return"&#"+t.charCodeAt(0)+";"});return e.length>255?!1:!0},completeStemFromWord:function(t){if("#"!==t[0]&&!this.options.no_hash)return!1;var e=t.replace(/^\#+/,"");return this.possiblyValid(e)?e:!1},cached_results:{},fetch:function(t){var e=this;if(t=t.toLowerCase(),this.cached_results[t]){if(this.cached_results[t].state)return this.cached_results[t];var s=$.Deferred();return setTimeout(function(){s.resolve(e.data_store)},1),s}var i=$.Deferred();return this.cached_results[t]=i,DiFi.pushPublicGet("DiscoveryTags","complete",[t],function(s,o){if(e.cached_results[t]=[],s){var r=$("<div/>");$.each(o.response.content,function(s,i){var o=r.html(i).text().toLowerCase();e.cached_results[t].push(o),e.data_store[o]={markup:'<span class="tag" data-tagName="'+o+'">'+i+"</span>"}})}i.resolve(e.data_store)}),DiFi.send(),i},confirm:function(){var t=this.$.find(".selected .tag").text();t&&this.outputText("#"+t),this.base()},renderItem:function(t){return'<div class="item">'+t.markup+"</div>"},keysForWord:function(t){return this.last_word==t?!this.cached_results[t]||this.cached_results[t].state?[]:this.cached_results[t]:[]}}),window.DWait&&DWait.run("jms/lib/autocomplete.js")});
window.WriterUtils={safeParseHTML:function(e){return e=$.parseHTML(e),$(e).find("*").addBack().removeAttr("onload onerror"),e},selectRange:function(e){window.getSelection().removeAllRanges(),window.getSelection().addRange(e)},getDescendantsByType:function(e,t){for(var r=[],n=document.createTreeWalker(e,t,null,!1);n.nextNode();)r.push(n.currentNode);return r},insertIntoTextareaAtCursor:function(e,t){var r=e.selectionStart,n=e.selectionEnd,o=e.scrollTop;e.value=e.value.substr(0,r)+t+e.value.substr(n),e.selectionStart=r+t.length,e.selectionEnd=r+t.length,e.scrollTop=o},isVisuallyEmpty:function(e){return!/[^ \t\r\n]/.test(e.textContent)&&!e.querySelector("img, iframe")},splitBlockquoteAtCursor:function(){var e=window.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0),r=$(t.startContainer).closest("blockquote");if(!r.length)return!1;t.deleteContents(),t.setEndAfter(r[0]);var n=t.extractContents();n.normalize();for(var o=n;o=o.firstChild;)if(o.tagName&&"IMG"!=o.tagName&&!o.textContent){var i=o.nextSibling;i&&"BR"==i.tagName&&$(i).remove(),$(o).remove();break}WriterUtils.isVisuallyEmpty(n)||r.after(n);var l=$("<br>");return r.after(l),WriterUtils.isVisuallyEmpty(r[0])&&r.remove(),t.setStartBefore(l[0]),e.removeAllRanges(),e.addRange(t),!0},killEmptyBlockquoteOnBackspace:function(){var e=window.getSelection();if((Browser.isIE||Browser.isWebkit)&&e.rangeCount){var t=e.getRangeAt(0).commonAncestorContainer;if("BLOCKQUOTE"==t.tagName&&WriterUtils.isVisuallyEmpty(t))return $(t).remove(),!0}},isCursorInBeginningOfListItem:function(){var e=document.getSelection();if(!e.rangeCount)return!1;for(var t=e.getRangeAt(0),r=t.startContainer,n=!t.startOffset;r&&n;){if("LI"==r.tagName)return!0;var o=r.parentNode;n=o&&o.firstChild==r,r=o}return!1},blockSidescroll:function(e,t){var r=t,n=r.which;if(!(r.altKey||r.shiftKey||r.ctrlKey||r.metaKey))if(!Browser.isGecko||37!=n&&39!=n)if(!Browser.isKHTML||33!=n&&34!=n){if(Browser.isKHTML&&(37==n||39==n)){var o=getSelection();if(o.isCollapsed&&o.rangeCount){var i=o.getRangeAt(0);o.modify("extend",37==n?"left":"right","character"),o.isCollapsed&&r.preventDefault(),o.removeAllRanges(),o.addRange(i)}}}else{for(var l=[];e=e.parentElement;)l.push(e.scrollLeft,e);setTimeout(function(){for(;l.length;)l.pop().scrollLeft=l.pop()},0)}else getSelection().modify("move",37==n?"left":"right","character"),r.preventDefault()},scrollSelectionIntoView:function(){var e,t,r,n,o,i,l,a,s,c;if(e=window.getSelection(),!e.focusNode)return!1;if(t=document.createRange(),t.setStart(e.focusNode,e.focusOffset),r=$('<span style="visibility: hidden">​</span>')[0],t.insertNode(r),n=r,r.scrollIntoViewIfNeeded)r.scrollIntoViewIfNeeded(!0);else for(;n!=window;){if(n=n.parentNode||window,n===window)a=0,s=$(n).height();else{if(!(n.scrollHeight>n.clientHeight&&/scroll|auto/.test($(n).css("overflow"))))continue;o=n.getBoundingClientRect(),a=o.top,s=o.bottom}o=r.getBoundingClientRect(),i=o.top,l=o.bottom,c=$(n).scrollTop(),a>i?$(n).scrollTop(c+i-a-20):l>s&&$(n).scrollTop(c+l-s+20)}return n=r.parentNode,n.removeChild(r),n.normalize(),!0},plainTextToHTML:function(e){return $("<div>").text(e).html().replace(/\t/,"    ").replace(/  /g," &nbsp;").replace(/\r?\n/g,"<br>")},plainTextListToHTML:function(e){for(var t=e.split(/\r?\n/),r=[],n=0;t.length>n;n++){var o=t[n].trim();if(/\*\s\S/.test(o))r.push("<li>"+WriterUtils.plainTextToHTML(o.substr(2))+"</li>");else if(o)return}return r.length>1?$("<ul>").html(r):null},usernameLinkToPlainText:function(e){var t=$("<div>").html(WriterUtils.safeParseHTML(e)),r=t.children("a.username").text();return r.match(/^[A-Za-z0-9][A-Za-z0-9-]{1,18}[A-Za-z0-9]$/)?"@"+r:""}},window.DWait&&DWait.run("jms/lib/writer/utils.js");
WriterEmbed=function(){function t(t){return/^(?:https?:)?\/\//i.test(t)?(t=$("<a>",{href:t})[0],{href:t.href,hash:t.hash,hostname:t.hostname,pathname:t.pathname,search:t.search,params:function(){for(var e={},i=t.search.slice(1).split("&"),a=0;i.length>a;a++){var r=i[a].split("=");e[decodeURIComponent(r[0]||"")]=decodeURIComponent(r[1]||"")}return e}()}):!1}function e(e){if(e=t(e)){var i,a=e.hostname.split(".").slice(-2).join(".");return"deviantart.com"==a||"deviantart.com"==a?(i=e.hash.match(/^#\/d(\w+)$/),i?i=parseInt(i[1],36):(i=e.pathname.match(/^\/?(?:art|journal)\/[^\/]+?-(\d+)\/?$/),i&&(i=+i[1]))):"deviantart.net"==a||"deviantart.net"==a?(i=e.pathname.match(/^\/fs\d{2}\/(?:f|PRE|i)(?:\/[fi])?\/\d{4}\/\d{3}\/[a-z0-9]\/[a-z0-9]\/[a-z0-9_]*-d(\w+)/),i&&(i=parseInt(i[1],36))):"sta.sh"==a||"sta.sh"==a?(i=(e.hash.match(/^#\/d(\w+)$/)||e.pathname.match(/^\/0(\w+)\/?$/)||[])[1],i&&(i=parseInt(i,36))):"fav.me"==a&&(i=(e.pathname.match(/^\/d(\w+)$/)||[])[1],i&&(i=parseInt(i,36))),i||null}}function i(t,e){var i="//backend.deviantart.com/oembed?url="+encodeURIComponent(t)+"&format=jsonp"+"&consumer=internal",a=$.Deferred();e=e||!1;var r=e?null:O[i];return r&&r.response?a.resolve(r.response):r&&r.error?a.resolve(r.error):$.ajax({url:i,timeout:5e3,dataType:"jsonp"}).done(function(t){t&&!t.error?(O[i]={response:t},a.resolve(t)):(O[i]={error:t},a.reject(t))}).fail(function(t,e,r){O[i]={error:r},a.reject(r)}),a}function a(t,e){var i,a=/redraw\/embed/.test(t.html),d=/embed\/madefire/.test(t.html),n=!a&&"video"==t.type,o="emoticon"==e.type;if(e.type="deviation","auto"==e.format&&(a?e.format="image":delete e.format),o){if(t.width*t.height>2500)return $("<img>");e.type="emoticon",i=$("<img>").attr({src:t.fullsize_url||t.url,width:t.width,height:t.height,alt:t.title})}else t.html&&!e.format?(d?e.height=e.height||600:n||(e.height=e.height||300),i=$("<div>",{"class":"writer-deviation-iframe",width:n?480:e.width||"",height:n?320:e.height}).append("<div>").append($(t.html).addClass("never-hide-me").removeAttr("style"))):!t.url&&!t.fullsize_url||e.format&&"image"!=e.format||t.social_preview?t.thumbnail_url&&"bigthumb"==e.format&&!t.social_preview?(i=$("<img>",{"class":"writer-deviation-thumbnail",src:t.thumbnail_url}),delete e.width,delete e.height,e.naturalwidth=t.width,e.naturalheight=t.height):t.thumbnail_url_200h&&"200H"==e.format&&!t.social_preview?(i=$("<img>",{"class":"writer-deviation-thumbnail",src:n?t.thumbnail_url:t.thumbnail_url_200h,css:{width:n?150:null}}),d&&i.addClass("writer-deviation-madefire-thumbnail"),delete e.width,delete e.height,e.thumb200width=t.thumbnail_width_200h,e.thumb200height=t.thumbnail_height_200h,e.naturalwidth=t.width,e.naturalheight=t.height):!t.thumbnail_url_150||"200H"!=e.format&&"thumb"!=e.format||t.social_preview?!t.thumbnail_html||"200H"!=e.format&&"thumb"!=e.format||(i=r(t.thumbnail_html).addClass("writer-deviation-lit-thumbnail")):(i=$("<img>",{"class":"writer-deviation-thumbnail",src:n?t.thumbnail_url:t.thumbnail_url_150,css:{width:n?150:null}}),d&&i.addClass("writer-deviation-madefire-thumbnail"),delete e.width,delete e.height,e.naturalwidth=t.width,e.naturalheight=t.height):(i=$("<img>",{"class":"writer-deviation-image",src:t.fullsize_url||t.url,width:e.width}),e.thumb200width=t.thumbnail_width_200h,e.thumb200height=t.thumbnail_height_200h,e.naturalwidth=t.fullsize_width||t.width,e.naturalheight=t.fullsize_height||t.height);return i&&(a&&(e.type="drawing"),i.addClass("writer-embed").attr({contenteditable:i.is("img, .generic-lit-thumb-iframe")?null:"false","data-embed-type":e.type,"data-embed-id":e.id,"data-embed-width":e.width,"data-embed-height":e.height,"data-embed-url":e.url,"data-embed-fallback":e.fallback,"data-embed-title":e.title||t.title,"data-embed-format":e.format,"data-embed-profile":e.profile,"data-embed-naturalwidth":e.naturalwidth,"data-embed-naturalheight":e.naturalheight,"data-embed-thumb200width":0|e.thumb200width,"data-embed-thumb200height":0|e.thumb200height,"data-embed-author":t.author_name,"data-embed-provider":t.provider_name}),a&&i.addClass("writer-deviation-redraw"),n&&i.addClass("writer-deviation-film")),i||!1}function r(t){return Browser.isFirefox?$('<iframe class="generic-lit-thumb-iframe" />').prop("src","data:text/html,"+encodeURIComponent("<!doctype html><style>body {width: 140px;height: 115px;background: linear-gradient(#f3f6f1, #e0e8dc);padding: 5px;margin: 0;font: 12px/18px Verdana, sans-serif;color: #222;overflow: hidden;}body > :first-child {display:block;padding-bottom: 6px;}img {max-width: 140px;}</style><body>"+$(t).find("q").html()+"</body>")):$(t)}function d(t,i){var a=e(t);return a?(i.url=t,i.id=a,n(i)):!1}function n(t){var e=$.Deferred();if(!t.id)return e.reject(),e;var r;return r=1e12>t.id||t.id.match(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/i)?document.location.protocol+"//www.deviantart.com/deviation/"+encodeURIComponent(t.id):document.location.protocol+"//sta.sh/0"+parseInt(t.id,10).toString(36),i(r,t.cached).done(function(i){t.url=t.url||r;var d=a(i,t);d?e.resolve(d):e.reject()}).fail(function(t){e.reject(t)}),e}function o(t){return U(t.id).then(function(t){return $("<img>").attr({src:"//st.deviantart.net/emoticons/"+t.src,width:t.w,height:t.h,alt:t.emoticon,"class":"writer-embed","data-embed-id":t.id,"data-embed-type":"emoticon"})})}function h(e,i,a){var r;if((!a||-1!=$.inArray("da:embed",a))&&(r=u(s(e))))return $.Deferred().resolve(r);if((!a||-1!=$.inArray("img",a))&&/\.(jpg|png|gif)$/i.test((t(e)||{}).pathname))return $.Deferred().resolve($("<img>",{src:e}));var n=$.Deferred();return(d(e,i)||$.Deferred().reject()).done(function(t){!a||P(t,a)?n.resolve(t):n.reject()}).fail(function(){n.reject()}),n}function m(t){return"embed"==t.type?$.Deferred().resolve(u(t)):"emoticon"==t.type?"deviation"==t.profile?n(t):o(t):"upload"==t.type?void 0:n(t)}function l(t,e,i){if(t=$.trim(t),-1!=$.inArray("da:thumb",e)){var a=t.match(/^:thumb(\d+):$/);if(a)return{type:"deviation",id:a[1],format:i||"thumb"};var r=WriterEmbed.deviationIdFromUrl(t);if(r)return{type:"deviation",id:r,format:i||"thumb",url:t,fallback:t}}if(-1!=$.inArray("da:bigthumb",e)){var d=t.match(/^:bigthumb(\d+):$/);if(d)return{type:"deviation",id:d[1],format:"bigthumb"}}return-1!=$.inArray("da:embed",e)?s(t):void 0}function s(e){var i={film:function(t){var e=t.href.match(/^https?:\/\/backend\.deviantart\.(?:com|lan)\/embed\/film\/(\d+)\/1\/$/);return e?(e=e[1],{id:e,url:document.location.protocol+"//backend.deviantart.com/embed/film/"+e+"/1/",width:638,height:360}):void 0},redraw:function(t){var e=t.href.match(/^https?:\/\/sta\.(?:sh|nk)\/muro\/redraw\/embed\/(.+)$/);return e?(e=e[1],{id:e,url:document.location.protocol+"//sta.sh/muro/redraw/embed/"+e,width:600,height:350}):void 0},status:function(t){var e=t.href.match(/^https?:\/\/(backend)\.deviantart\.(?:com|lan)\/embed\/status\/(\w+)\/(\d+)\/?$/);if(e||(e=t.href.match(/^https?:\/\/(\w+)\.deviantart\.(?:com|lan)\/status\/(\d+)\/?$/)),e){var i,a;return e[3]?(i=e[2],a=e[3]):(i=e[1],a=e[2]),{id:i+":"+a,url:document.location.protocol+"//backend.deviantart.com/embed/status/"+i+"/"+a,width:500,height:150}}},youtube:function(t){var e=null;return"youtu.be"==t.hostname?e=t.pathname.substr(1):/^(www\.)?youtube(-nocookie)?\.com$/.test(t.hostname)&&(e="/watch"==t.pathname?t.params.v:(t.pathname.match(/^\/embed\/([^\/]+)/)||[])[1]),e?{id:e,url:document.location.protocol+"//youtube.com/watch?v="+e,width:560,height:315}:void 0},vimeo:function(t){var e=null;return"vimeo.com"==t.hostname||"www.vimeo.com"==t.hostname?e=t.pathname.substr(1):"player.vimeo.com"==t.hostname&&0===t.pathname.indexOf("/video/")&&(e=(t.pathname.match(/\/video\/(\d+)/)||[])[1]),e&&!/\D/.test(e)?{id:e,url:document.location.protocol+"//vimeo.com/"+e,width:500,height:281}:void 0},"facebook-video":function(t){var e=null;return"www.facebook.com"==t.hostname&&(e=t.pathname.replace(/\/$/,"").split("/").pop()),e?{id:t.href.split("?")[0],width:400,height:300}:void 0},revision3:function(t){var e=null;return"revision3.com"==t.hostname?e=(t.pathname.match(/^\/html5player-v(\d+)/)||[])[1]:"embed.revision3.com"==t.hostname&&(e=t.params.videoId),e?{id:e,width:640,height:360}:void 0},ustream:function(t){var e=null;return("ustream.tv"==t.hostname||"www.ustream.tv"==t.hostname)&&(e=(t.pathname.match(/\/(?:channel|embed)\/(\d+)/)||[])[1]),e?{id:e,width:480,height:296}:void 0},soundcloud:function(t){var e=null;return"w.soundcloud.com"==t.hostname&&(e=((t.params.url||"").match(/api\.soundcloud\.com\/tracks\/(\d+)/)||[])[1]),e?{id:e,width:"100%",height:166}:void 0},sketchfab:function(t){var e=null;return"sketchfab.com"==t.hostname&&(e=(t.pathname.match(/\/models\/(\w+)/)||[])[1]),e?{id:e,url:"https://sketchfab.com/models/"+e,width:640,height:480}:void 0},verold:function(t){var e=null;return/verold\.com$/.test(t.hostname)&&(e=(t.pathname.match(/^\/projects\/([0-9a-f]+)/)||[])[1]),e?{id:e,width:640,height:480}:void 0},twitch:function(t){var e=null,i=null;if("twitch.tv"==t.hostname||"www.twitch.tv"==t.hostname){var a=t.pathname.match(/\/(\w+)(\/v\/(\d+))?/)||[];e=a[1],i=a[3]}else"player.twitch.tv"==t.hostname&&(e=t.params.channel||"video",i=(t.params.video||"").substr(1));return vms_feature("twitch_embed")&&e?{id:e+(i?":"+i:""),url:"https://www.twitch.tv/"+e+(i?"/v/"+i:""),width:640,height:480}:void 0}};e=$.trim(e);var a=$("<div>").append(WriterUtils.safeParseHTML(e)),r=a.children("iframe:first-child");r.length||(r=a.find(".sketchfab-embed-wrapper iframe:first-child"));var d,n,o,h={type:"embed"};if(r.length?(d=r.attr("src"),h.width=r.attr("width"),h.height=r.attr("height")):(d=e,h.url=e),d=t(d),!d)return!1;for(o in i)if(n=i[o](d))return h.profile=o,$.extend(n,h);return!1}function u(t){var e;if(!t)return!1;if("youtube"==t.profile||"youtube-analytics"==t.profile)e="//www.youtube.com/embed/"+t.id+"?wmode=opaque";else if("vimeo"==t.profile)e="//player.vimeo.com/video/"+t.id;else if("film"==t.profile)e="//backend.deviantart.com/embed/film/"+t.id+"/1/";else if("redraw"==t.profile)e="//sta.sh/muro/redraw/embed/"+t.id;else if("status"==t.profile)e="//backend.deviantart.com/embed/status/"+t.id.replace(/:/,"/");else if("shared-deviation"==t.profile)e="//backend.deviantart.com/embed/shared-deviation/"+t.id,t.width||(t.width="100%"),t.height||(t.height="240");else if("revision3"==t.profile)e="//revision3.com/player-v"+t.id;else if("ustream"==t.profile)e="//www.ustream.tv/embed/"+t.id;else if("ooyala"==t.profile)e=t.id.length>=64?"//st.deviantart.net/ooyala3.html?2#/"+t.width+"/"+t.height+"/"+t.id+"/":"//player.ooyala.com/player.swf?embedCode="+t.id+"&version=2&keepEmbedCode=true";else if("soundcloud"==t.profile)e="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/"+t.id+"&amp;color=ff5500&amp;auto_play=false&amp;visual=true";else if("sketchfab"==t.profile)e="https://sketchfab.com/models/"+t.id+"/embed";else if("verold"==t.profile)e="//studio.verold.com/projects/"+t.id+"/embed";else if(vms_feature("twitch_embed")&&"twitch"==t.profile){var i=t.id.split(":",2);e=i.length>1?"https://player.twitch.tv/?video=v"+i[1]:"https://player.twitch.tv/?channel="+t.id,e+="&autoplay=false"}else{if("facebook-video"!=t.profile)return ddt.log("writer","Attempt to embed an unknown profile",t),!1;e="https://www.facebook.com/plugins/video.php?href="+encodeURIComponent(t.id)+"&width="+t.width+"&height="+t.height}var a={width:t.width,height:t.height,"data-embed-type":"embed","data-embed-profile":t.profile,"data-embed-id":t.id,"data-embed-width":t.width,"data-embed-height":t.height,"data-embed-url":t.url,"data-embed-title":t.title,"data-embed-format":t.format,"data-embed-fallback":t.fallback},r={src:e,"class":"never-hide-me",scrolling:"no",frameborder:"0"};return"status"==t.profile||"shared-deviation"==t.profile?(a.readonly=!0,a.contenteditable=!1,$("<div>",a).addClass("writer-status-iframe writer-embed").append("<div>").append($("<iframe>",r))):($.extend(a,r),$("<iframe>",a).addClass("writer-embed"))}function c(t){return $("<img>",{src:t.loadersrc||"//st.deviantart.net/minish/stash/writer/holder.png",id:"writer-embed-loader-"+($.now()+q++),"class":"writer-embed-loader",width:t.loaderwidth,height:t.loaderheight,"data-embed-type":t.type,"data-embed-profile":t.profile,"data-embed-id":t.id,"data-embed-width":t.width,"data-embed-height":t.height,"data-embed-format":t.format,"data-embed-cache":void 0===t.cached?!0:t.cached,"data-embed-url":t.url,"data-embed-fallback":t.fallback})}function f(t){var e=b(t);if(e){var i=document.createElement(e.tagName);for(var a in e.attributes)i.setAttribute(a,e.attributes[a]);return i}}function b(t){if(/^(deviation|embed|emoticon|drawing)$/.test(t.type)){var e=t.type,i={id:t.id},a=/^(thumb|200H|bigthumb)$/.test(t.format);return"deviation"==t.type&&("thumb"==t.format?e="thumb":"bigthumb"==t.format?e="bigthumb":"200H"==t.format&&(e="thumb",i.format="200H")),"drawing"==t.type&&(i.format=t.format),("embed"==t.type||"emoticon"==t.type)&&(i.profile=t.profile),!a&&t.width&&(i.width=t.width),!a&&t.height&&(i.height=t.height),{tagName:"da:"+e,attributes:i}}}function v(t){return{type:t.attr("data-embed-type"),profile:t.attr("data-embed-profile"),id:t.attr("data-embed-id"),width:t.attr("data-embed-width"),height:t.attr("data-embed-height"),url:t.attr("data-embed-url"),title:t.attr("data-embed-title"),format:t.attr("data-embed-format"),cached:t.attr("data-embed-cache"),author:t.attr("data-embed-author"),provider:t.attr("data-embed-provider"),fallback:t.attr("data-embed-fallback")}}function w(t){var e={type:t[0].tagName.substr(3).toLowerCase(),profile:t.attr("profile"),id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),format:t.attr("format")};return("thumb"==e.type||"bigthumb"==e.type)&&("200H"!=e.format&&(e.format=e.type),e.type="deviation"),e}function p(t){t.find(".writer-embed-loader").each(function(){var t=this.id,e=v($(this)),i=m(e);i&&i.done(function(e){if($("#"+t).before(e).remove(),e.is("img")){var i=new Image,a=5,r=e[0],d="//st.deviantart.net/minish/stash/stashing.gif",n=r.src;i.src=n,i.onload=function(){r.src=i.src},i.onerror=function(){a--?(r.src=d,setTimeout(function(){i.src=n+"?"+$.now()},2e3)):r.src="about:blank"}}PubSub.publish("WriterEmbed.loaded",e)}).fail(function(i){$("#"+t).before(e.fallback&&i&&"404 Not Found"==i.error?$("<img>").prop("src",e.fallback):document.createTextNode(y(this.outerHTML))).remove()})}),PubSub.publish("WriterEmbed.loading",t)}function g(t){return t.find("da\\:deviation, da\\:thumb, da\\:bigthumb, da\\:embed, da\\:emoticon, da\\:drawing").replaceWith(function(){return c(w($(this)))}),t}function y(t){return t?"string"==typeof t&&(t=$("<div></div>").html(WriterUtils.safeParseHTML(t))):t=$("<div></div>"),t.find(".writer-embed, .writer-embed-loader, iframe").replaceWith(function(){var t;return t=$(this).is("iframe")&&!$(this).closest(".writer-embed").length?f(s(this.outerHTML)):f(v($(this))),t||(t=$("<div></div>").text(this.outerHTML).html()),t}),t.html().replace(/<\/da:[^>]+>/gi,"")}function k(t){var e=t.find("[data-embed-type]:not(.writer-embed, .writer-embed-loader)");e.replaceWith(function(){return c({type:$(this).attr("data-embed-type"),profile:$(this).attr("data-embed-profile"),id:$(this).attr("data-embed-id"),width:$(this).attr("data-embed-width"),height:$(this).attr("data-embed-height"),format:$(this).attr("data-embed-format"),url:$(this).attr("data-embed-url"),fallback:$(this).attr("data-embed-fallback")})}),t.find('a > img.avatar[alt^=":"]').unwrap().replaceWith(function(){return document.createTextNode(this.alt)}),t.find('img[src~="e.deviantart."][alt]').replaceWith(function(){return document.createTextNode(this.alt)})}function _(t,e){var i=+t.attr("data-embed-naturalwidth")||null,a=+t.attr("data-embed-naturalheight")||null,r="200H"==e.format?+t.attr("data-embed-thumb200width"):150,d="200H"==e.format?+t.attr("data-embed-thumb200height"):150;return t.is(".writer-deviation-film, .writer-deviation-madefire-thumbnail")||"deviation"==t.data("embed-type")&&-1==$.inArray("da:deviation",e.valid_tags)?{resizeable:!1}:t.is(".writer-deviation-image, .writer-deviation-thumbnail")?{resizable:i>r||a>d,minSize:[r,d],maxSize:[i,a],aspectRatio:[i,a]}:t.is(".writer-status-iframe")?{resizable:!0}:t.is(".writer-deviation-iframe")?{resizable:!0,minSize:[r,d]}:x(t)?{resizable:!0,minSize:[150,150],maxSize:[t[0].naturalWidth,t[0].naturalHeight],aspectRatio:[t[0].naturalWidth,t[0].naturalHeight]}:{resizable:!1}}function x(t){return t.is("img:not(.writer-embed)")}function T(t){return t.is(".writer-deviation-thumbnail, .writer-deviation-lit-thumbnail")}function z(t){return t.is(".writer-deviation-image, .writer-deviation-iframe")||x(t)&&Math.max(t.width(),t.height())>150}function j(t){return t.is(".writer-deviation-thumbnail, .writer-deviation-lit-thumbnail")&&!t.is(".writer-deviation-redraw")||x(t)&&+t.attr("width")&&t[0].naturalWidth>+t.attr("width")}function I(t){return t.is(".writer-deviation-redraw")&&!t.is(".writer-deviation-image")}function H(t){return t.is(".writer-deviation-redraw")&&!t.is(".writer-deviation-iframe")}function W(t){if(!t.is(".writer-deviation-film, .writer-deviation-madefire-thumbnail")&&(t.is(".writer-deviation-thumbnail")||t.is(".writer-deviation-image"))){if(-1!==t.attr("src").indexOf("/minish/stash/stash-empty-item_120.png"))return!1;if(-1!==t.attr("src").indexOf("/minish/bears/empty-544.png"))return!1;if(Glbl("Site.is_stash")||Glbl("Site.is_stash_writer"))return!0;if("sta.sh"==t.attr("data-embed-provider"))return!0;if(window.deviantART.deviant.loggedIn&&window.deviantART.deviant.username==t.attr("data-embed-author"))return!0}return!1}function A(t){return!!v(t).url}function C(t,e){var i=+t[0].style.width.replace(/px/,"")||"",a=+t[0].style.height.replace(/px/,"")||"";if(x(t))return t.prop({width:i}),void 0;t.attr({"data-embed-width":i,"data-embed-height":a});var r="200H"==e.format?+t.attr("data-embed-thumb200width"):150,d="200H"==e.format?+t.attr("data-embed-thumb200height"):150;t.is(".writer-deviation-thumbnail")&&(t.width()>r||t.height()>d)?R(t):(t.is(".writer-deviation-image")||"bigthumb"==t.attr("data-embed-format"))&&r>=t.width()&&d>=t.height()&&D(t,e)}function S(t,e,i){if(x(e)){var a=e[0].naturalWidth,r=e[0].naturalHeight;if("thumb"==t){var d=150/Math.max(a,r);1>d&&e.attr("width",Math.round(a*d)).css({width:"",height:""})}else{if("auto"!=t)return;e.css({width:"",height:""}).removeAttr("width").removeAttr("height")}}return i=i||{},i.format||(i.format=t),n($.extend(v(e),i)).done(function(t){e.replaceWith(t)})}function D(t,e){return S("thumb",t,e)}function R(t){return S("auto",t)}function E(t){return S("redraw",t)}function F(t){return S("image",t)}function L(t){var e=v(t);e.url&&t.replaceWith($("<a>",{href:e.url,text:e.title||"[link]"}))}function M(){if(M.result&&"rejected"!=M.result.state())return M.result;var t=M.result=$.Deferred(),e=6;return DiFi.pushPublicGet("Emoticons","getWriterList",[e],function(e,i){e?t.resolve(i.response.content):t.reject()}),DiFi.send(),t}function U(t){var e=$.Deferred();if(U.cache){var i=U.cache[t];i?e.resolve(i):e.reject()}else M().done(function(i){var a=U.cache={};for(var r in i)a[i[r].id]=i[r];U.cache=a;var d=U.cache[t];d?e.resolve(d):e.reject()}).fail(function(){e.reject()});return e}function N(e){if(/^data:/.test(e))return!0;if(e=t(e),!e)return!1;var i=e.hostname.split(".").slice(-2).join(".");return $.inArray(i,["deviantart.com","deviantart.com","sta.sh","sta.sh","dreamup.com","dreamup.com","fav.me","youtube.com","youtube-nocookie.com","youtu.be","vimeo.com","revision3.com","ustream.tv","ooyala.com","soundcloud.com","sketchfab.com","verold.com","twitch.tv"])>=0}function P(t,e){var i=b(v(t));return i?$.inArray(i.tagName,e)>=0:!1}function G(t){var e=/^(id|class|contenteditable|src|width|height|scrolling|frameborder|data.+)$/i;t.find("*").add(t).each(function(){for(var t,i=this.style.width,a=this.style.height,r=this.style.backgroundImage,d=Array.prototype.slice.call(this.attributes),n=0;t=d[n];n++)e.test(t.name)||this.removeAttribute(t.name);this.src&&"IMG"!=this.tagName&&!N(this.src)&&$(this).remove(),i&&(this.style.width=i),a&&(this.style.height=a),r&&(this.style.backgroundImage=r)})}var O={},q=0;return{damlToLoaders:g,runLoaders:p,damlFromHtml:y,htmlFromLink:h,loaderFromAttrs:c,isValidEmbedTag:P,attrsFromEmbedCode:l,deviationIdFromUrl:e,normalizeServerRenderedDaml:k,onResize:C,resizeMode:_,isThumbnail:T,isSwitchableToThumbnail:z,isSwitchableToFullSize:j,isSwitchableToRedraw:H,isSwitchableToImage:I,isSwitchableToLink:A,isEditableInMuro:W,switchToThumbnail:D,switchToFullSize:R,switchToRedraw:E,switchToImage:F,switchToLink:L,getEmoticons:M,isTrustedSource:N,sanitizeHtml:G}}(),window.DWait&&DWait.run("jms/lib/writer/embed.js");
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js"],function(){window.WriterStorage=Base.extend({constructor:function(t,i){this.title_callback=t,this.metadata_callback=i,this.onSaveStart=$.Callbacks(),this.onSaveEnd=$.Callbacks(),this.empty_hash=this.hash=this.saved_hash=this._hash("",!0),this.is_saving=!1,this.last_save=!1},id:function(t){return t?this.privateid:this.deviation_id},save:function(t,i,s,e){if(window.deviantART.deviant.id&&!this.is_saving&&!this.is_loading){t=this._process_saved_value(t);var n=this._hash(t);if(n!==this.saved_hash||e)return this.hash=n,this.is_empty()?(this.id()&&this.remove(),s&&i(),void 0):(this.is_saving=!0,this._save(t,i))}},_save:function(t,i){return this.deviation_id?DiFi.pushPost("Stash","update_journal",[this.deviation_id,this.deviation_version,this.title_callback(),t,this.metadata_callback()],this._save_done.bind(this,i)):DiFi.pushPost("Stash","create_journal",[deviantART.deviant.id,this.title_callback(),t,-1,this.metadata_callback()],this._save_done.bind(this,i)),this.onSaveStart.fire(),DiFi.send(),!0},_save_done:function(t,i,s){this.is_saving=!1,i&&(this.deviation_id=s.response.content.stashid,this.deviation_version=s.response.content.version,this.privateid=s.response.content.privateid,this.last_save=$.now(),this.saved_hash=this.hash,t(s.response.content)),this.onSaveEnd.fire(i,s.response)},load:function(t,i){this.is_loading=!0,DiFi.pushPost("Deviation","GetOriginalText",[t],this._load_done.bind(this,i)),DiFi.send()},_load_done:function(t,i,s){if(this.is_loading=!1,!i)return this.clear(),t.options.on_load_error(s.response.content),void 0;var e=s.response.content;e.stash&&(this.deviation_version=e.version,this.deviation_id=e.id,this.privateid=e.privateid),this._set_content(e,t)},load_external_text:function(t,i){this._set_content({text:t},i),i.update_placeholder()},_set_content:function(t,i){t=this._process_loaded_content(t,i),i.setInitialText(t.text),i.options.on_load_content(t),i.save_requested_after_loading&&(i.save_requested_after_loading=!1,i.saveContent()),this.hash=this.saved_hash=this._hash(t.text)},remove:function(t,i){this.deviation_id&&t&&(DiFi.pushPost("Deviation","DeleteSingle",[this.deviation_id,1],i),DiFi.send()),this.clear()},clear:function(){this.deviation_id=!1,this.deviation_version=!1,this.privateid=!1,this.hash=this.saved_hash=this.empty_hash},is_empty:function(){return this.hash==this.empty_hash},is_dirty:function(t){return this.saved_hash!=this._hash(t)},_hash:function(t,i){return t=$.trim(t)+"title:"+$.trim(this.title_callback()||""),$.each(this.metadata_callback()||{},function(s,e){t+=i?s+":":s+":"+(e||"")}),t},_process_saved_value:function(t){return t},_process_loaded_content:function(t){return t},last_save_string:function(){if(!this.last_save)return"never";var t=new Date(this.last_save),i=t.getHours(),s=i>=12?"pm":"am",e=t.getMinutes();return i>12?i-=12:1>i&&(i+=12),10>e&&(e="0"+e),i+":"+e+s}}),window.WriterStorageNoSave=WriterStorage.extend({_save:function(t,i){setTimeout(function(){this._save_done(i,!0,{response:{content:{stashid:!1,privateid:!1,version:0,is_stash:!1,url:"",short_url:""}}})}.bind(this),1)},is_dirty:function(){return!0}}),window.DWait&&DWait.run("jms/lib/writer/storage.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/writer/utils.js","jms/lib/writer/embed.js"],function(){window.WriterSyncer=Base.extend({default_options:{valid_tags:["[a-zA-Z:]+"],valid_attrs:["[a-zA-Z:]+"]},constructor:function(t,e){this.writer=t,this.options=$.extend({},this.default_options,e)},sync:function(t){var e;if(t){if(e=this.textarea_value(),this.writer.storage.is_dirty(e))return this.set_writer_value(this.to_html(e)),!0}else if(e=this.from_html(this.writer_value()),this.writer.storage.is_dirty(e))return this.set_textarea_value(e),!0},textarea_value:function(){return this.writer.$textarea.val()},set_textarea_value:function(t){this.writer.$textarea.val(t).change()},writer_value:function(){return this.writer.$node.html()},set_writer_value:function(t){this.writer.$node.html(t),WriterEmbed.runLoaders(this.writer.$node)},to_html:function(t){ddt.log("writerverbose","to_html passed",t);var e=this.writer;t=t.replace(/\n/g,"<br />"),t=t.replace(/<da:(deviation|thumb|bigthumb|embed|emoticon|drawing|widget) ([^>]+)>/gi,function(t,e){return t+"</da:"+e+">"});var r=$("<div>").html(WriterUtils.safeParseHTML(t));r.find("style, script, textarea, .thumb-attachment, .thumb-attachment-content").remove(),r.find("da\\:widget").attr("wytiwyg",1);for(var i=r.find("[wytiwyg]");i.length>0;){var a=i.eq(0),s=a.clone().removeAttr("wytiwyg").empty()[0].outerHTML,n=RegExp("</"+a[0].tagName+">$","i"),o=s.match(n);s=s.replace(n,""),o&&!a[0].tagName.match(/^da:/i)&&a.after(document.createTextNode(o[0])),a.before(document.createTextNode(s)),a.replaceWith(a.html()||document.createTextNode("")),i=r.find("[wytiwyg]")}var d=this.options.valid_tags,l=this;return r.find("*").each(function(){if(-1==$.inArray(this.nodeName.toLowerCase(),d)){try{$(this).contents().unwrap()}catch(t){}$(this).remove()}else 0===this.tagName.indexOf("DA:")||l.sanitize_attributes(this)}),r.find("a").each(function(){e.update_link_style(this)}),ddt.log("writerverbose","to_html produced",r.html()),WriterEmbed.damlToLoaders(r).html()},from_html:function(t){ddt.log("writerverbose","from_html passed",t);var e=$("<div>").html(WriterUtils.safeParseHTML(t));return WriterUtils.getDescendantsByType(e[0],NodeFilter.SHOW_TEXT).forEach(function(t){/^<iframe[^>]*><\/iframe>/.test(t.nodeValue)?$(t).replaceWith(WriterUtils.safeParseHTML(t.nodeValue)):t.nodeValue=t.nodeValue.replace(/(https?:\/\/[^\s<"]+)\u00A0/gi,"$1 ")}),e.find("*").each(function(){"A"===this.tagName&&$(this).removeClass("external"),""===this.className&&this.removeAttribute("class"),/:/.test(this.tagName)&&$(this).remove()}),t=WriterEmbed.damlFromHtml(e),t=t.replace(/<br[^>]*>/g,"\n"),-1==$.inArray("da:drawing",this.options.valid_tags)&&(t=t.replace("<da:drawing ","<da:thumb ")),t=this.unescape_wytiwygs(t),t=$.trim(t),ddt.log("writerverbose","from_html produced",t),t},unescape_wytiwygs:function(t){var e="("+this.options.valid_tags.join("|")+")",r=RegExp("&lt;(/?)"+e+"([\\s/].*?)?&gt;","gi"),i=function(t,e,r,i){return e?"</"+r+">":(i=$("<div>").html(i).text(),"<"+r+' wytiwyg="1"'+i+">")};return t.replace(r,i)},sanitize_attributes:function(t){if(t.attributes.length)for(var e=RegExp("^(?:"+this.options.valid_attrs.join("|")+")$","i"),r=$.makeArray(t.attributes),i=0;r.length>i;i++)e.test(r[i].name)||t.removeAttribute(r[i].name)}}),window.DWait&&DWait.run("jms/lib/writer/syncer.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js"],function(){window.DeviationWriterStatusNotifier=Base.extend({getFileMenu:$.noop,getTitle:$.noop,forceAlert:!1,invalidTitle:null,constructor:function(t){this.onSaveStart=$.proxy(this,"onSaveStart"),this.onSaveEnd=$.proxy(this,"onSaveEnd"),this.storage=t,t.onSaveStart.add(this.onSaveStart),t.onSaveEnd.add(this.onSaveEnd)},destroy:function(){var t=this.getFileMenu();t&&(t.clearError(),t.toggleProgress(!1)),this.storage.onSaveStart.remove(this.onSaveStart),this.storage.onSaveEnd.remove(this.onSaveEnd)},onSaveStart:function(){var t=this.getFileMenu();t&&t.toggleProgress(!0)},onSaveEnd:function(t,e){var i=this.getFileMenu(),n=this.getTitle();if(i&&i.toggleProgress(!1),t)i&&i.clearError(),e.content.title_error?n!=this.invalidTitle&&(this.invalidTitle=n,DiFi.stdErr(null,e.content.title_error)):this.invalidTitle=null;else{var r=this.menuMessageFromDiFiResponse(e);r&&i&&!this.forceAlert?i.setError(r):DiFi.stdErr(null,e.content)}},menuMessageFromDiFiResponse:function(t){var e=t.content.error.code;return"ERR_INVALID_RESPONSE"==e?"No Internet Connection":"ERR_DIFI_ACCESS_DENIED"==e?"Not Logged In":"ERR_TEXT_MAX_SIZE_EXCEEDED"==e?"Document is Too Large to Save":"ERR_UNAUTHORIZED"==e?"Editing Privileges Lost":void 0}}),window.DWait&&DWait.run("jms/lib/writer/status_notifier.js")});
DWait.ready(["jms/lib/ddt.js","jms/lib/jquery/jquery.current.js","jms/lib/writer/writer.js","jms/lib/Base.js"],function(){var t=Base.extend({constructor:function(){this.storage={},this.default_options={separate_ident:!1}},get:function(t,e,i){var s,r;return this.options=$.extend({},this.default_options,i),t=this._id(t),ddt.log("writer","extracted id",t),this.storage[t]?this.storage[t]:(r=this.options.separate_ident?$("[ident="+t+"]"):$("#"+t),0===r.length?{success:!1,message:"Unable to locate textarea '#"+t+"'."}:(s=new Writer(t,r,e),this.storage[t]=s,s))},toggle:function(t,e,i){this.options=$.extend({},this.default_options,i);var s=this.get(this._id(t),e,i);return!s||s.success!==void 0&&!s.success||s.toggle(!0),s},destroy:function(t){t=this._id(t),this.storage[t]&&(this.storage[t].destroy(),delete this.storage[t])},destroyAll:function(){for(var t in this.storage)this.storage[t].destroy(),delete this.storage[t]},_id:function(t){if("string"!=typeof t){var e=$(t),i=e.attr("writer")||e.data("writer");if(e.length&&"TEXTAREA"==e[0].nodeName){var s=e[0];i||(i=s.getAttribute("id")),(!i||this.options.separate_ident)&&(i="writer"+Math.round(1e10*Math.random()),this.options.separate_ident?s.setAttribute("ident",i):s.setAttribute("id",i))}t=i}return t}});window.WriterFactory=new t,window.DWait&&DWait.run("jms/lib/writer/factory.js")});
DWait.ready(["jms/lib/browser.js","jms/lib/toolbar.js","jms/lib/popuptoolbar.js","jms/legacy/modals.js","jms/lib/popup2.js","jms/lib/jquery/plugins/jquery.throttle-debounce.js","jms/lib/jquery/plugins/jquery.transit.js"],function(){var t=window.WriterToolbarAction=PopupToolbarAction.extend({act:function(t){this.base(t),this.toolbar.updateStates(),this.isMenu||(this.getWriter().$node.focus(),Popup2.hideAll())},enforceRichMode:function(){return this.getWriter().enforceRichMode()},toggleState:function(t){this.enforceRichMode()&&(this.getWriter().beginEdit(),document.execCommand(t,!1),this.getWriter().endEdit(),this.toolbar.updateStates())},destroy:$.noop,getWriter:function(){return this.toolbar.getWriter()}}),e=window.WriterToolbarMenuAction=t.extend({constructor:function(t,e){this.base(t,e),this.popup_name=this.popup_name||"WriterPopup"+this.name},act:function(t){(!this.requires_rich_mode||this.enforceRichMode())&&this.base(t)},requires_rich_mode:!0,position_options:function(){var t=this.base();return t.bump.top+=1,t.bump.left-=5,t},reuse_popup:!1,isMenu:!0}),i={bold:t.extend({name:"bold",label:"B",title:"Bold",keyBind:66,act:function(){this.toggleState("bold")}}),italic:t.extend({name:"italic",label:"I",title:"Italic",keyBind:73,act:function(){this.toggleState("italic")}}),underline:t.extend({name:"underline",label:"U",title:"Underline",keyBind:85,act:function(){this.toggleState("underline")}}),ul:t.extend({name:"ul",label:"UL",title:"Unordered list",act:function(){this.enforceRichMode()&&this.getWriter().insertUnorderedList()}}),ol:t.extend({name:"ol",label:"OL",title:"Ordered list",act:function(){this.enforceRichMode()&&this.getWriter().insertOrderedList()}}),alignl:t.extend({name:"alignl",label:"Left Align",title:"Left Align",act:function(){this.enforceRichMode()&&this.getWriter().align("left")}}),alignc:t.extend({name:"alignc",label:"Center Align",title:"Center Align",act:function(){this.enforceRichMode()&&this.getWriter().align("center")}}),alignr:t.extend({name:"alignr",label:"Right Align",title:"Right Align",act:function(){this.enforceRichMode()&&this.getWriter().align("right")}}),blockquote:t.extend({name:"blockquote",label:"Quote",title:"Quote",act:function(){this.enforceRichMode()&&(this.getWriter().toggleBlockquote(),this.toolbar.updateStates())}}),undo:t.extend({name:"undo",label:"&#9100;",title:"Undo",act:function(){var t=this.getWriter();t&&t.undo&&t.inRichMode()?t.undo():document.execCommand("undo",!1,null)}}),redo:t.extend({name:"redo",label:"&#9100;",title:"Redo",act:function(){var t=this.getWriter();t&&t.redo&&t.inRichMode()?t.redo():document.execCommand("redo",!1,null)}}),headings:e.extend({name:"headings",label:"Headings",title:"Headings",switch_on_hover:!1,popup_options:function(){return{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:'<div class="blockmenu"><li data-value="1" class="h1">H1 title</li><li data-value="2" class="h2">H2 subtitle</li><li data-value="3" class="h3">H3 header</li><li data-value="4" class="h4">H4 subheader</li><li data-value="5" class="h5">H5 smaller</li><li data-value="0">Normal</li></div>',events:[{selector:"li",event:"click",callback:function(t){var e=+$(t.currentTarget).data("value"),i=this.getWriter();i.restore_selection(),i.setHeadingSize(e)}.bind(this)}]}},position_options:function(){var t=this.base();return t.bump.top-=46,t.bump.left+=5,$("body").hasClass("ccwriter-subframe")&&($("body").hasClass("ccwriter-journal")?$("body").hasClass("stickhelper")?t.bump.top-=21:t.bump.top+=4:t.bump.top+=46),t}}),link:e.extend({name:"link",label:"Link",title:"Link",switch_on_hover:!1,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},_get_popup_options:function(){return{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:['<div class="blockmenu">','<form class="writer-subtoolbar-link-form">','<div style="margin-bottom:0.8em">',"<strong>URL</strong><br />",'<input type="text" class="text" name="url" placeholder="example.com"><br />','<label for="url" class="error">Did you provide a URL?</label>',"</div>",'<div style="margin-bottom:0.8em">',"<strong>Title (optional)</strong><br />",'<input type="text" class="text" name="title" placeholder="Enter link title" value=""><br />',"</div>",'<div style="margin-bottom:0.8em">','</div><input type="submit" class="smbutton smbutton-white" value="OK" style="height: 22px; min-width: 66px; margin: 2px 0 6px;">',"</form>","</div>"].join("\n"),hidden:function(t){this.default_popup_options().hidden.call(this,t),this.$node.parents(".commentwriter-toolbar").removeClass("overbearing")}.bind(this),shown:function(t){var e=this.getWriter();this.default_popup_options().shown.call(this,t),e.restore_selection();var i=e.get_selection(),o=$(i.commonAncestorContainer).closest("a"),s=o.length?o.attr("href"):"",r=o.length?o.text():""+i;t.$node.show(),t.$node.find("input[name=title]").val(r),t.$node.find("input[name=url]").val(s).focus(),this.$node.parents(".commentwriter-toolbar").addClass("overbearing")}.bind(this),events:[{selector:"form",event:"submit",callback:function(t){t.preventDefault();var e=t.data.popup.$node,i=this.getWriter(),o=$.trim(e.find('input[name="url"]').val()),s=$.trim(e.find('input[name="title"]').val()),r=0===o.indexOf("<");if(!o)return e.find("label.error").show(),void 0;e.find("label.error").hide(),!r&&1>o.indexOf(":")&&(o="http://"+o);var n=function(){i.addLink(o,s),i.sync(),Popup2.hideAll()};return setTimeout(function(){if(!r&&s)n();else{var t=WriterEmbed.htmlFromLink(o,{format:i.insert_thumbs?i.insert_thumb_format||"thumb":"auto"},i.options.valid_tags);t?(e.find("input:submit").val("Loading..."),t.done(function(t){i.insert(t),Popup2.hideAll()}).fail(function(){r||n()}).always(function(){e.find("input:submit").val("OK")})):n()}},0),!0}.bind(this)}]}},position_options:function(){var t=this.base();return t.bump.top-=46,t.bump.left+=5,$("body").hasClass("ccwriter-subframe")&&($("body").hasClass("ccwriter-journal")?$("body").hasClass("stickhelper")?t.bump.top-=21:t.bump.top+=4:t.bump.top+=46),t}}),edit:e.extend({name:"edit",label:"Edit",title:"Edit",requires_rich_mode:!1,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},position_options:function(){var t=this.base();return $("body").hasClass("ccwriter-subframe")&&(t.bump.top-=1,t.bump.left+=5),t},_get_popup_options:function(){return{classes:$("body").hasClass("ccwriter-journal")||location.href.indexOf("/writer")>=0?"stashwriter-embed stashwriter-toolbar-menu with-icons":"writer-embed",allow_class_override:$("body").hasClass("ccwriter-journal"),allow_parent_override:$("body").hasClass("ccwriter-journal"),content:['<div class="blockmenu">','<li class="writer-toolbar-toggle-thumbsize"><i></i>Always Add Full Size Images</li>','<li class="writer-toolbar-switch-to-html"><i></i>Switch to HTML Mode</li>','<li class="writer-toolbar-switch-to-rich"><i></i>Switch to Rich Editing Mode</li>',"</div>"].join(""),shown:function(t){this.default_popup_options().shown.call(this,t),this.getWriter().inRichMode()?(t.$node.find(".writer-toolbar-switch-to-rich").hide(),t.$node.find(".writer-toolbar-switch-to-html").show()):(t.$node.find(".writer-toolbar-switch-to-rich").show(),t.$node.find(".writer-toolbar-switch-to-html").hide())}.bind(this),created:function(t){t.$node.find(".writer-toolbar-toggle-thumbsize").toggleClass("toggled-off",!!this.getWriter().insert_thumbs)}.bind(this),events:[{selector:".writer-toolbar-switch-to-html, .writer-toolbar-switch-to-rich",event:"click",callback:function(){var t=this.getWriter();t.inRichMode()?t.switchToHtmlMode():t.switchToRichMode()}.bind(this)},{selector:".writer-toolbar-toggle-thumbsize",event:"click",callback:function(t){var e=$(t.currentTarget),i=e.hasClass("toggled-off"),o=this.getWriter();return e.toggleClass("toggled-off"),o.insert_thumbs=!i,setTimeout(function(){o.restore_selection(),Popup2.hideAll()},300),!0}.bind(this)}]}}}),zoom:e.extend({name:"zoom",label:"100%",title:"Zoom",switch_on_hover:!1,popup_options:function(){return{classes:"stashwriter-toolbar-menu",allow_class_override:!0,allow_parent_override:!0,content:'<div class="blockmenu"><li data-value="1">100%</li><li data-value="0.75">75%</li><li data-value="0.5">50%</li><li data-value="0.25">25%</li><li data-value="0.1" class="last">10%</li></div>',events:[{selector:"li",event:"click",callback:function(t){var e=this.getWriter(),i=$(t.currentTarget),o=i.data("value");$(".stashwriter-subtoolbar div[class*=-zoom] span").text(i.text()),e.$node.closest(".writer-zoom-container").transition({transform:"scale("+o+")","transform-origin":"50% 0"}),e.restore_selection()}.bind(this)}]}},position_options:function(){var t=this.base();return t.bump.top-=46,t.bump.left+=5,t}}),file:e.extend({name:"file",label:"File",title:"File",requires_rich_mode:!1,_errorMessage:null,_spinner:null,popup_options:function(){return this._memoized_popup_options=this._memoized_popup_options||this._get_popup_options()},position_options:function(){var t=this.base();return $("body").hasClass("ccwriter-subframe")&&(t.bump.top-=1,t.bump.left+=5),t},_get_popup_options:function(){return{classes:"stashwriter-file stashwriter-toolbar-menu with-icons",allow_class_override:$("body").hasClass("ccwriter-journal"),allow_parent_override:$("body").hasClass("ccwriter-journal"),content:['<ul class="blockmenu">','<li class="writer-toolbar-draft-autosave disabled">','<div class="writer-toolbar-draft-autosave-error"></div>','Last Autosave: <span class="writer-autosave-timestamp">never</span></li>','<li class="separator"></li>','<li class="writer-toolbar-draft-new"><i></i>New <span class="weak">Draft...</span></li>','<li class="writer-toolbar-draft-open-browse"><i></i>Open <span class="weak">Draft...</span></li>','<li class="writer-toolbar-draft-save"><i></i>Save <span class="weak">Draft</span></li>',"</ul>"].join(""),shown:function(t){this.default_popup_options().shown.call(this,t),this._popupOpen=!0,t.$node.find(".writer-autosave-timestamp").html(this.getWriter().storage.last_save_string());var e=t.$node.find(".writer-toolbar-draft-autosave-error");this._errorMessage?(t.$node.addClass("error"),e.text(this._errorMessage).show()):(t.$node.removeClass("error"),e.empty().hide())}.bind(this),hidden:function(t){this.default_popup_options().hidden.call(this,t),this._popupOpen=!1,this.$node.toggleClass("error",!!this._errorMessage)}.bind(this),events:[{selector:".writer-toolbar-draft-new",event:"click",callback:function(){this.getWriter().draft_handler.do_new()}.bind(this)},{selector:".writer-toolbar-draft-open-browse",event:"click",callback:function(){this.show_browse()}.bind(this)},{selector:".writer-toolbar-draft-save",event:"click",callback:function(){this.getWriter().draft_handler.do_save(),this.getWriter().restore_selection()}.bind(this)}]}},show_browse:function(){DWait.ready(["jms/pages/stash/stash.js"],function(){this._openDraftModal()}.bind(this))},_openDraftModal:function(){var t=this.modal=Modals.factory($('<div><div class="title"><h2>Open File</h2></div><div class="main"></div></div>'),{extraClassy:"loadDraftModal"});t.addButton("Close"),Modals.push(t,function(){PubSub.unsubscribe([{eventname:"Stash.item_open",subscriber:this},{eventname:"StashEmbedded.folder_loaded",subscriber:this},{eventname:"StashEmbedded.root_loaded",subscriber:this}]),PubSub.publish("WriterSidebar.start_stash",!0)}.bind(this)),t.getjQNode().on("click",".moveUp",function(t){t.preventDefault(),PubSub.publish("Stash.root_open")}),PubSub.subscribe([{eventname:"Stash.item_open",subscriber:this,callback:this._modalItemChosen.bind(this)},{eventname:"StashEmbedded.folder_loaded",subscriber:this,callback:this._modalFolderLoaded.bind(this)},{eventname:"StashEmbedded.root_loaded",subscriber:this,callback:this._modalRootLoaded}]),PubSub.publish("WriterSidebar.stop_stash"),Glbl("Stash.mode","plain|no_upload"),Glbl("Stash.filter","writer_drafts"),Glbl("Stash.browselimit",18),PubSub.publish("StashEmbedded.start"),DiFi.pushPost("Stashes","get_folder_id",["Drafts"],function(t,e){t&&e.response.content.size>1?PubSub.publish("Stash.folder_open",{id:e.response.content.id}):PubSub.publish("Stash.root_open")}),DiFi.send()},_modalFolderLoaded:function(t,e){var i=$(e),o=this.modal.getjQNode().find(".main");o.empty().append('<div class="navLink">&lt; <a href="#" class="moveUp">Sta.sh</a></div>'),i.find('.stash-tt-a[collect_rid!="1:0"]').length?i.appendTo(o):o.append('<h2 class="nofiles">You do not have any saved drafts.<h2>'),o.animate({scrollTop:0},"slow")},_modalRootLoaded:function(t,e){var i=$(e),o=this.modal.getjQNode().find(".main").empty();i.find('.stash-tt-a[collect_rid!="1:0"]').length?i.appendTo(o):o.append('<h2 class="nofiles">You do not have any saved drafts.<h2>'),o.animate({scrollTop:0},"slow")},_modalItemChosen:function(t,e){Modals.pop("cancel"),this.getWriter().draft_handler.do_load(e.deviationid)},setError:function(t){this._errorMessage=t,this._popupOpen||this.$node.addClass("error")},clearError:function(){this._errorMessage=null,this._popupOpen||this.$node.removeClass("error")},toggleProgress:function(t){t&&!this._spinner?(this.$node.addClass("autosaving"),this._spinner=new Spinner($.extend({},SpinnerPresets.green,{top:4,left:-2})),this._spinner.spin(this.$node.find("b")[0])):!t&&this._spinner&&(this.$node.removeClass("autosaving"),this._spinner.stop(),this._spinner=null)},destroy:function(){this.base(),this._spinner&&this._spinner.stop()}}),separator:t.extend({name:"separator",label:"",act:$.noop,render:function(){return this.$node=$('<div class="writer-toolbar-separator"></div>')}})};window.WriterToolbar=Toolbar.extend({actions:i,writer:null,create:function(t,e){this.base(t,e),this.$toolbar.addClass("writer-toolbar")},rebind:function(){var t=this.$toolbar.is(":visible")?150:1e3,e=$.throttle(t,this.updateStates.bind(this));this.$node.off(".writer-toolbar").on("keyup.writer-toolbar",e),$("html").off(".writer-toolbar").on("mouseup.writer-toolbar",e)},updateStates:function(){var t=this.getWriter().get_selection();t&&(this.$toolbar.find(".writersub-toolbar-bold").toggleClass("active",document.queryCommandState("bold")),this.$toolbar.find(".writersub-toolbar-italic").toggleClass("active",document.queryCommandState("italic")),this.$toolbar.find(".writersub-toolbar-underline").toggleClass("active",$(t.commonAncestorContainer).closest("a").length?!1:document.queryCommandState("underline")),this.$toolbar.find(".writersub-toolbar-blockquote").toggleClass("active",$(t.commonAncestorContainer).closest("blockquote").length>0))},destroy:function(){for(var t=0;this.toolbar.length>t;t++)this.toolbar[t].destroy();this.base()},getWriter:function(){return this.writer},setWriter:function(t){this.writer=t}}),window.DWait&&DWait.run("jms/lib/writer/toolbar.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/popup2.js","jms/lib/dragger.js","jms/lib/spinpreset.js","jms/lib/pubsub.js"],function(){window.WriterImageControls=Base.extend({default_options:{attach_point:null,allowed_image_actions:["Draw","Image","Full","Thumb","Link","Remove"],image_actions_by_priority:["Remove","Thumb","Full","Link","Draw","Image"]},triggers:".writer-embed, .portfoliofile, .portfoliothumb, img",constructor:function(t,i){this.options=$.extend({},this.default_options,i),this.attach_point=this.options.attach_point||null,this.writer=t,this.$node=t.$node,this.attach(this.writer)},attach:function(t){var i=this;t!=this.writer&&(this.writer=t);var e=this.$node.parent();this.attach_point&&(e=this.$node.closest(this.attach_point));var s=$();this.resizer=new WriterImageControls.Resizer(this),s=s.add(this.resizer.$),this.menu=new WriterImageControls.MenuActionsOverlay(this,e),s=s.add(this.menu.$),i.$node.on("keydown",function(){i.hide(!0)}).on("dragstart",function(){i.hide(!0)}).on("mouseover",this.triggers,function(){i.show(this)}).on("mouseout",this.triggers,function(){i.hide()}),s.off(".writerimagecontrols").on("mouseover.writerimagecontrols",function(){clearTimeout(i.hideTimer)}).on("mouseout.writerimagecontrols",function(){i.$current&&!i.resizer.resizing&&i.$current.trigger("mouseout")}),PubSub.subscribe({eventname:"WriterEmbed.loaded",subscriber:this,callback:this.embed_loaded})},show:function(t){t=$(t),this.resizer.resizing||t.is(".deleting")||"emoticon"==t.data("embed-type")||t.parents(this.triggers).length||(clearTimeout(this.hideTimer),this.$current&&this.$current[0]==t[0]||(this.$current=t,this.resizer.show(t),this.menu.show(t)))},hide:function(t){this.$current&&(t?(clearTimeout(this.hideTimer),this.resizer.hide(),this.menu.hide(!0),this.$current=null):this.hideTimer=setTimeout(this.hide.bind(this,!0),500))},add_status:function(t,i,e){return this.clear_status(t),"error"===i?WriterImageControls.Status.set_error(this,t,e):"saving"===i?WriterImageControls.Status.set_saving(this,t):WriterImageControls.Status.set_loading(this,t)},clear_status:function(t){WriterImageControls.Status.clear(t)},embed_loaded:function(t,i){if(!this.$current){this.waiting_on_embed&&clearTimeout(this.waiting_on_embed);var e=i.is("img")?i:i.find("img");!e.length||void 0!==e[0].naturalWidth&&0!==e[0].naturalWidth||e[0].complete?(i.trigger("mouseover"),i.trigger("mouseout")):this.waiting_on_embed=setTimeout(function(){this.embed_loaded(t,i)}.bind(this))}}}),window.WriterImageControls.MenuActions=Base.extend({constructor:function(t,i){this.controls=t,this.$=this.create().appendTo(i)},show:function(t){this.$.css(this.position(t)).fadeIn()},hide:function(t){t?this.$.fadeOut("fast"):this.$.hide()},position:function(t){var i=t.position();return i.left=i.left+t.width()-this.$.width()-5,i.top=i.top+5,this.controls.attach_point&&(i.left-=this.controls.writer.$node.position().left,i.top-=this.controls.writer.$node.position().top),i},actions:{Remove:{label:"Remove",enabled:function(){return!0},act:function(t){t.addClass("deleting").slideUp("fast",function(){this.controls.writer.setFocusAfter(t[0]),this.controls.writer.beginEdit("delete_embed"),t.remove(),this.controls.writer.endEdit()}.bind(this))}},Draw:{label:"Edit in DeviantArt muro",enabled:function(t){return WriterEmbed.isEditableInMuro(t)},act:function(t){var i=t.attr("data-embed-id");if(i){var e,s,r,n,o=this,a=this.controls.writer,h=Glbl("Site.is_deviantart")?document.location.protocol+"//muro.deviantart.com":document.location.protocol+"//sta.sh/muro";a.frame(h+"/iframe?devid="+i,function(i,h){var d="remove";switch(i.action){case"error":return h.hidden&&o.controls.add_status(t,"error",function(){h.act("show")}),void 0;case"cancel":return o.controls.clear_status(t),"remove";case"got_id":return e=i.id&&parseInt(i.id,36),void 0;case"done":d="hide",i.img&&(r={src:i.img,width:i.image_width,height:i.image_height}),o.controls.add_status(t,"saving"),setTimeout(function(){e||o.controls.clear_status(t)},15e3);break;case"save":e=i.privateid||i.id,r={src:i.img,width:i.image_width,height:i.image_height},o.controls.clear_status(t);break;case"ready":var c=t.clone().css({position:"fixed","z-index":1001,top:t.offset().top-window.scrollY,left:t.offset().left-window.scrollX,width:t.get(0).clientWidth,height:t.get(0).clientHeight}).appendTo("body");return h.$.promise().done(function(){c.css({zoom:1}).animate({top:i.canvas_y,left:i.canvas_x,width:i.image_width*i.zoom,height:i.image_height*i.zoom},{duration:600,complete:function(){c.remove()}})}),"show";default:return}if(r)if(e){if(!s){var l=$("<img>",{src:r.src,"class":"writer-embed writer-deviation-redraw writer-deviation-"+("image"===t.attr("data-embed-format")?"image":"thumbnail"),"data-embed-id":e,"data-embed-type":"drawing","data-embed-format":t.attr("embedformat")||"image","data-embed-naturalwidth":t.attr("data-embed-naturalwidth"),"data-embed-naturalheight":t.attr("data-embed-naturalwidth")});t.attr("data-embed-width")&&l.attr("data-embed-width",t.attr("data-embed-width")).width(t.attr("data-embed-width")),"thumb"===t.attr("data-embed-format")&&l.css("max-width","150px").css("max-height","150px"),l.data("writer-imagecontrol-status",t.data("writer-imagecontrol-status")),a.beginEdit("edit_in_muro"),t.replaceWith(l),a.endEdit(),WriterEmbed.runLoaders(a.$node),t=l,s=!0,n&&a.markAsDoneSaving()}}else t.attr({src:r.src}),n||(a.markAsSaving(),n=!0);return d}),this.controls.add_status(t)}}},Thumb:{label:"Switch to Thumb",enabled:function(t){return WriterEmbed.isSwitchableToThumbnail(t)},act:function(t){var i=t;if(this.controls.writer.beginEdit("switch_to_thumb"),i.is(".portfoliofile")){var e,s,r=i.width(),n=i.height();r>=n?(e=150,s=n/r*e):(s=150,e=r/n*s),i.width(e).height(s).removeClass("portfoliofile").addClass("portfoliothumb")}else WriterEmbed.switchToThumbnail(i,{format:this.controls.writer.insert_thumbs?this.controls.writer.insert_thumb_format:null});this.controls.writer.endEdit()}},Full:{html:"Full size",label:"Switch to Full Size",enabled:function(t){return WriterEmbed.isSwitchableToFullSize(t)},act:function(t){var i=t;this.controls.writer.beginEdit("switch_to_fullsize"),i.is(".portfoliothumb")?i.removeAttr("width").removeAttr("height").removeClass("portfoliothumb").addClass("portfoliofile").css({width:"",height:""}):WriterEmbed.switchToFullSize(i),this.controls.writer.endEdit()}},Link:{label:"Switch to Link",enabled:function(t){return WriterEmbed.isSwitchableToLink(t)},act:function(t){this.controls.writer.beginEdit("switch_to_link"),WriterEmbed.switchToLink(t),this.controls.writer.endEdit()}},Redraw:{label:"Switch to muro Redraw",enabled:function(t){return WriterEmbed.isSwitchableToRedraw(t)},act:function(t){this.controls.writer.beginEdit("switch_to_redraw"),WriterEmbed.switchToRedraw(t),this.controls.writer.endEdit()}},Image:{label:"Switch to Image",enabled:function(t){return WriterEmbed.isSwitchableToImage(t)},act:function(t){this.controls.writer.beginEdit("switch_to_image"),WriterEmbed.switchToImage(t),this.controls.writer.endEdit()}},Test:{label:"Developer status test",enabled:function(){return ddt.watching("writer")},act:function(t){t.data("writer-imagecontrol-status")?this.controls.clear_status(t):this.controls.add_status(t)}}}}),window.WriterImageControls.MenuActionsOverlay=window.WriterImageControls.MenuActions.extend({create:function(){for(var t=this,i=$('<div class="writer-imagemenu"></div>').hide().on("click",".action",function(i){i.preventDefault(),i.stopPropagation();var e=$(this).data("action");t.actions[e]&&t.actions[e].act.call(t,t.controls.$current)!==!1&&t.controls.hide(!0)}),e=this.controls.options.allowed_image_actions,s=0;e.length>s;s++){var r=t.actions[e[s]];$('<div class="action action-with-label">').html(r.html||e[s]).attr("data-action",e[s]).prop("title",r.label).prepend("<i></i>").appendTo(i)}return $('<div class="action tiny-remove">').attr("data-action","Remove").appendTo(i),i},show:function(t){var i=this,e=82,s=30,r=t.width(),n=t.height(),o=i.controls.options.allowed_image_actions,a=i.controls.options.image_actions_by_priority,h=a.filter(function(e){return $.inArray(e,o)>=0&&i.actions[e].enabled(t)}),d=$.inArray("Remove",h)>=0;h=h.slice(0,n/s),h.length&&r>=e?(i.$.find(".tiny-remove").hide(),i.$.find(".action-with-label").each(function(t,i){var e=$(i).data("action");$(i).toggle($.inArray(e,h)>=0)}),this.base(t)):d&&(i.$.find(".action-with-label").hide(),i.$.find(".tiny-remove").show(),this.base(t))}}),window.WriterImageControls.Resizer=Base.extend({constructor:function(t){this.image_controls=t,this.resizing=!1,this.min_size=[1,1],this.max_size=[1/0,1/0],this.aspect_ratio=null,this._$element=null,this.$=this._create_handles(),this._bind_events()},show:function(t){this.image_controls.$node[0].oncontrolselect=function(){return!1};try{document.execCommand("enableObjectResizing",!1,!1)}catch(i){}if(!this.image_controls.options.prevent_resize){t=$(t);var e=WriterEmbed.resizeMode(t,{format:this.image_controls.writer.insert_thumbs?this.image_controls.writer.insert_thumb_format:null,valid_tags:this.image_controls.writer.options.valid_tags});this.resizing||!e.resizable&&!t.is(".portfoliofile")||(this._$element=t,this.min_size=e.minSize,this.max_size=e.maxSize,this.aspect_ratio=e.aspectRatio,this.$.appendTo(this.image_controls.$node.parent()),this._update_size())}},hide:function(){this.resizing||this.$.detach()},on_start:function(){this.image_controls.menu.hide(),this.image_controls.writer.beginEdit("resize_element")},on_stop:function(){WriterEmbed.onResize(this._$element,{format:this.image_controls.writer.insert_thumbs?this.image_controls.writer.insert_thumb_format:null}),this.image_controls.writer.endEdit()},_update_size:function(t){t&&this._$element.css({width:t.width,height:"IMG"==this._$element[0].tagName?"auto":t.height});var i=this._$element.position(),e=this._$element.width(),s=this._$element.height(),r=this;this.$.each(function(t){var n={left:i.left+(1&t?e:0),top:i.top+(2&t?s:0)};r.image_controls.attach_point&&(n.left-=r.image_controls.writer.$node.position().left,n.top-=r.image_controls.writer.$node.position().top),$(this).css(n)})},_create_handles:function(){return $('<div class="writer-resize-handle nw" /><div class="writer-resize-handle ne" /><div class="writer-resize-handle sw" /><div class="writer-resize-handle se" />')},_bind_events:function(){var t,i,e,s,r,n=this;new Dragger(n.$,n.image_controls.$node.parent(),function(o,a,h){n.resizing=!0,t=$.inArray(h,n.$),i=n._$element.width(),e=n._$element.height(),s=o[0],r=o[1],n.on_start()},function(o){n._update_size(n._constrain_size({width:i+(1&t?1:-1)*(o[0]-s),height:e+(2&t?1:-1)*(o[1]-r)}))},function(){n.resizing=!1,n.hide(),n.on_stop()})},_constrain_size:function(t){var i=t.width,e=t.height,s=this.min_size&&this.min_size[0]||1,r=this.min_size&&this.min_size[1]||1,n=this.max_size&&this.max_size[0]||1/0,o=this.max_size&&this.max_size[1]||1/0;if(this.aspect_ratio){var a=this.aspect_ratio[0],h=this.aspect_ratio[1],d=(i*h-e*a)/(h*h+a*a);i-=d*h,e+=d*a,(i>n||e>o)&&(i=a*Math.min(n/a,o/h),e=h*Math.min(n/a,o/h)),s>i&&r>e&&(i=a*Math.min(s/a,r/h,1),e=h*Math.min(s/a,r/h,1))}else i=Math.min(i,n),e=Math.min(e,o),i=Math.max(i,s),e=Math.max(e,r);return{width:Math.round(i),height:Math.round(e)}}}),window.WriterImageControls.Status=Base.extend({constructor:function(){this.spinner=new Spinner($.extend({},SpinnerPresets.green,{top:-13,left:-7})),this.$status=$('<div class="writer_imagestatus"><div class="message"></div></div>')},attach:function(t,i,e,s){var r=i.position();this.$status.appendTo(t.$node.parent()).css({left:r.left,top:r.top,width:i.width(),height:i.height()});var n=this.$status.find(".message").html(e);n.css({left:(i.width()-n[0].offsetWidth)/2,top:(i.height()-n[0].offsetHeight)/2}),s&&n.click(s),i.data("writer-imagecontrol-status",this),this.spinner.spin(this.$status.find(".positive")[0])},detach:function(t){this.$status.remove(),t.removeData("writer-imagecontrol-status")}},{_stack:[],set:function(t,i,e){var s=WriterImageControls.Status._stack.pop();s||(s=new WriterImageControls.Status),s.attach(t,i,e)},clear:function(t){var i=t.data("writer-imagecontrol-status");i&&(i.detach(t),WriterImageControls.Status._stack.push(i))},set_loading:function(t,i){WriterImageControls.Status.set(t,i,'&nbsp;<span class="positive"></span>&nbsp;&nbsp; Loading...')},set_saving:function(t,i){WriterImageControls.Status.set(t,i,'&nbsp;<span class="positive"></span>&nbsp;&nbsp; Saving...')},set_error:function(t,i,e){WriterImageControls.Status.set(t,i,'<span class="negative">Error</span> - Click Here for Details',e)}}),window.DWait&&DWait.run("jms/lib/writer/imagecontrols.js")});
DWait.ready(["jms/lib/carotid.js","jms/lib/ddt.js","jms/lib/popup2.js","jms/lib/bind.js","jms/lib/jquery/jquery.current.js","jms/lib/Base.js"],function(){window.LinkEditor=Base.extend({constructor:function(i){this.$node=$(i).off(".linkeditor").on("keyup.linkeditor paste.linkeditor writereditcomplete.linkeditor click.linkeditor",this.caret_check.bind(this)),this.popup=new Popup2("writer-link-editor"+$.now(),"body",{content:$("<i></i><span>URL</span><br><input>"),classes:"writer-link-editor",hidden:function(){if(!this.$link)return ddt.log("writerlinkeditor","didn't edit link","no $link"),void 0;var i=this.popup.$node.find("input").val();if(i){if(1>i.indexOf(":")&&(i=document.location.protocol+"//"+i),i==this.$link.attr("href"))return ddt.log("writerlinkeditor","didn't edit link","identical url"),void 0;ddt.log("writerlinkeditor","edited link",i),this.$link.attr("href",i);var t=this.$node.data("writer");t&&t.update_link_style(this.$link)}else ddt.log("writerlinkeditor","removed link",i),this.$link.replaceWith(function(){return this.innerHTML});this.$node.trigger("change")}.bind(this)})},show:function(i){this.$link=$(i),this.popup.show(this.popup.position(this.$link)),this.popup.$node.find("input").val(this.$link.attr("href")),this.popup.$node.off(".linkeditor").on("keydown.linkeditor","input",this.popup_keydown.bind(this))},hide:function(){this.isShown()&&this.popup.hide()},isShown:function(){return this.popup.visible()},caret_check:function(){var i=Carotid.getNode(this.$node[0]);if(!$(i).closest(".writer-embed").length){var t=$(i).closest("a");t.length?this.show(t):this.hide()}},popup_keydown:function(i){switch(i.which){case 13:case 27:this.hide()}}}),window.DWait&&DWait.run("jms/lib/writer/linkeditor.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/Base.js","jms/lib/browser.js","cssms/lib/writer.css","jms/lib/writer/storage.js","jms/lib/writer/syncer.js","jms/lib/writer/utils.js","jms/lib/writer/embed.js","jms/lib/writer/toolbar.js","jms/lib/writer/imagecontrols.js","jms/lib/writer/undo.js","jms/lib/writer/linkeditor.js","jms/lib/pubsub.js","jms/lib/jquery/ui/jquery.ui.droppable.js","jms/lib/php.js","jms/lib/jquery/plugins/jquery.scrollto.js","jms/lib/autocomplete.js","jms/lib/popup2.js"],function(){window.Writer=Base.extend({default_options:{on_load_content:$.noop,on_load_error:$.noop,on_save_content:$.noop,on_remove_content:$.noop,on_switch_editing_mode:$.noop,content:!1,draft_handler:"DraftHandler",content_id:!1,draft_metadata:function(){return{}},draft_title:function(){return"Draft"},syncer:WriterSyncer,sync_timeout:2e3,storage:WriterStorage,valid_tags:["br","hr","strong","b","code","sub","sup","small","tt","acronym","a","abbr","strike","em","i","u","ins","span","blockquote","p","bcode","ul","ol","dl","pre","li","cut","div","da:embed","da:deviation","da:thumb","da:bigthumb","da:widget","da:emoticon","da:drawing","img","font","table","tbody","tr","td","h1","h2","h3","h4","h5","h6"],valid_attrs:["align","alt","class","height","href","name","skinscript","src","title","width","target","data-.+"],allow_html_mode:!0,passthrough_tab:!1,block_sidescroll:!1,imagecontrol_options:null,stash_upload:!0,autocomplete_priority:!1,call_on_save_if_empty:!1,placeholder_if_focused:!1,skin_id:0},constructor:function(t,e,i){this.options=$.extend({},this.default_options,i),this.id=t+"-writer",this.editingMode="rich",this.create(e),"string"==typeof this.options.syncer&&(this.options.syncer=Writer[this.options.syncer]),this.syncer="function"==typeof this.options.syncer?new this.options.syncer(this,{valid_tags:this.options.valid_tags,valid_attrs:this.options.valid_attrs}):this.options.syncer,"string"==typeof this.options.storage&&(this.options.storage=Writer[this.options.storage]),this.storage="function"==typeof this.options.storage?new this.options.storage(this.options.draft_title,this.options.draft_metadata):this.options.storage,"string"==typeof this.options.draft_handler&&(this.options.draft_handler=Writer[this.options.draft_handler]),this.draft_handler="function"==typeof this.options.draft_handler?new this.options.draft_handler(this):this.options.draft_handler,this.save_actions=[],this.history=new WriterUndo(this),this.attach(e),e.attr("writer",t),Writer.setActive(this)},toString:function(){return"[Writer "+this.id+"]"},isSaving:function(){return this.storage.is_saving||this.sync_queued||this.save_override},markAsSaving:function(){this.save_override=(this.save_override||0)+1},markAsDoneSaving:function(){this.save_override=Math.max((this.save_override||0)-1,0),this.runSaveCallbacks()},whenSaved:function(t){this.isSaving()?this.save_actions.push(t):t(this)},runSaveCallbacks:function(){if(this.isSaving())return ddt.log("writer","tried to run save callbacks while saving"),void 0;for(var t;t=this.save_actions.pop();)t(this)},isDirty:function(){return this.storage.is_dirty(this.getContent())},getContent:function(t){return t&&this.sync(),this.$textarea.val()},getHTMLContent:function(){return this.$node.html()},setContent:function(t){ddt.log("writerverbose","setContent",t),this.$node.html(t),this.sync()},setInitialText:function(t){ddt.log("writerverbose","setting text",t),this.syncer.set_textarea_value(t),this.syncer.sync(!0)},setText:function(t){this.setInitialText(t),this.saveContent()},saveContent:function(t){return this.storage.is_loading?(this.save_requested_after_loading=!0,void 0):this.storage.save(this.getContent(),this.savedContent.bind(this),this.options.call_on_save_if_empty,t)},savedContent:function(t){this.options.on_save_content(t),this.runSaveCallbacks()},removeSavedContent:function(t,e){this.storage.remove(t,this.options.on_remove_content.bind(this)),e&&e.call(this)},loadContent:function(t){this.storage.load(t,this)},clearDefault:function(){this.update_placeholder(),this.$node.hasClass("empty")&&this.is_empty()&&(this.getContent()&&this.setContent(""),this.options.placeholder_if_focused||this.$node.removeClass("empty"))},onPasteFinished:function(){var t=this.options.valid_tags,e=this.syncer;this.$node.find("style, script, textarea, .thumb-attachment, .thumb-attachment-content").remove(),WriterEmbed.normalizeServerRenderedDaml(this.$node),this.$node.find(".writer-embed, .writer-embed-loader").each(function(){WriterEmbed.isValidEmbedTag($(this),t)?WriterEmbed.sanitizeHtml($(this)):$(this).remove()}),WriterEmbed.runLoaders(this.$node),this.$node.find("*:not(.writer-embed, .writer-embed *, .writer-embed-loader)").each(function(){-1==$.inArray(this.nodeName.toLowerCase(),t)?($(this).contents().unwrap(),$(this).remove()):(parseFloat(this.style.textIndent)&&$(this).prepend("&nbsp;&nbsp;&nbsp;&nbsp;"),this.style.textAlign&&(this.align=this.style.textAlign),e.sanitize_attributes(this))});var i=WriterUtils.getDescendantsByType(this.$node[0],NodeFilter.SHOW_COMMENT);$(i).remove();for(var s=WriterUtils.getDescendantsByType(this.$node[0],NodeFilter.SHOW_TEXT),n=0;s.length>n;n++)if("PRE"!=s[n].parentNode.tagName){var o=s[n].nodeValue,r=o.replace(/[\r\n\t ]+/g," ");r!=o&&(s[n].nodeValue=r)}this.update_all_links()},onPaste:function(t){this.beginEdit("paste"),setTimeout($.proxy(this,"onPasteFinished"),0);var e=t.originalEvent.clipboardData||window.clipboardData,i=e&&e.getData("text");if(i){if(!this.prevent_paste_formatting){var s=WriterEmbed.attrsFromEmbedCode(i,this.options.valid_tags,this.insert_thumb_format);if(s)return this._insert_into_selection(WriterEmbed.loaderFromAttrs(s)),t.preventDefault(),void 0;var n=WriterUtils.plainTextListToHTML(i);if(n)return this._insert_into_selection(n),t.preventDefault(),void 0}return Browser.isSafari&&i&&!/text\/rtf/.test(e.types)||Browser.isChrome&&i&&!/text\/html/.test(e.types)?(this._insert_into_selection(WriterUtils.plainTextToHTML(i)),t.preventDefault(),void 0):void 0}},onDrop:function(t){this.beginEdit("drop"),setTimeout($.proxy(this,"onPasteFinished"),0);var e=t.originalEvent.dataTransfer;if(e){var i=e.getData("text/uri-list");if(i&&/^data:/.test(i))t.preventDefault();else if(/data-embed-id="\d+"/.test(e.getData("text/html"))&&$.inArray("da:thumb",this.options.valid_tags));else if(i){var s=WriterEmbed.deviationIdFromUrl(i);s&&$.inArray("da:thumb",this.options.valid_tags)&&(this._insert_into_selection(WriterEmbed.loaderFromAttrs({type:"deviation",id:s,format:this.insert_thumb_format||"thumb",fallback:i})),t.preventDefault())}}},onCut:function(){this.beginEdit("cut"),setTimeout($.proxy(this,"endEdit"),0)},onClick:function(){this.clearDefault(),Writer.setActive(this)},sync:function(){this.sync_queued&&clearTimeout(this._sync_timer),this.sync_queued=!1;var t=this.syncer.sync(this.inHtmlMode());return t&&this.isDirty()&&Writer.getActive()&&(t=this.saveContent()),this.update_placeholder(),PubSub.publish("Writer.sync",t),t},scheduleSync:function(){this.sync_queued&&clearTimeout(this._sync_timer),this.sync_queued=!0,this._sync_timer=setTimeout($.proxy(this,"sync"),this.options.sync_timeout)},onBlur:function(){this.scheduleSync(),this.update_placeholder()},onKeyUp:function(){this.prevent_paste_formatting=!1,this.scheduleSync();var t=this.get_selection(),e=t&&$(t.commonAncestorContainer).closest(".writer-embed");e&&e.length&&this.setFocusAfter(e[0]),this.remember_selection()},onChange:function(){this.scheduleSync()},create:function(t){return this.$node=$("#"+this.id),0===this.$node.length&&(this.$node=$("<div></div>",{id:this.id,"class":"writer selectable no-lub put-art-here"}).css("padding-bottom","1em").data("writer",this),t.removeAttr("style").addClass("writer")),this.visible=!1,this.$node.hide(),this.createToolbars(t),this.$node},createToolbars:function(t,e){this.toolbars=[];var i,s,n;if(e)for(n in e)i=this.id+"/"+e[n].toolbar_name,s=Toolbars[i]?Toolbars[i]:new WriterToolbar(i,this.$node,this.sync.bind(this),e[n]),this.toolbars.push(s);else if(t&&t.attr("toolbar")){i=t.attr("toolbar");for(n in Toolbars)n.split("/")[0]==i&&(Toolbars[n].rebind(),this.toolbars.push(Toolbars[n]));if(0===this.toolbars.length){var o=this.options.toolbars&&this.options.toolbars.length?this.options.toolbars[0]:{};this.toolbars.push(new WriterToolbar(i,this.$node,this.sync.bind(this),o))}}else if(this.options.toolbars)for(n in this.options.toolbars)i=this.id+"/"+this.options.toolbars[n].toolbar_name,s=Toolbars[i]?Toolbars[i]:new WriterToolbar(i,this.$node,this.sync.bind(this),this.options.toolbars[n]),this.toolbars.push(s);this.toolbars.forEach(function(t){t.setWriter(this)}.bind(this))},destroy:function(){$.each(this.toolbars,function(t,e){e.destroy()}),this.image_controls&&this.image_controls.hide(!0),this.$node.remove(),this.$textarea.show()},attach:function(t){var e=this;this.$textarea=t,this.$textarea.val()==this.$textarea.attr("placeholder")&&this.$textarea.val(""),this.$textarea.height()&&(this.$node[0].style.minHeight=this.$textarea.height()+"px"),this.options.match_textarea_width&&(this.$node[0].style.width=this.$textarea.width()+"px"),this.$node.insertBefore(this.$textarea),this.visible&&this.show(),this.image_controls?this.image_controls.attach(this):this.image_controls=new WriterImageControls(this,this.options.imagecontrol_options),this.$node.add(this.$textarea).off(".writer"),this.$node.is(":ui-droppable")||this.$node.droppable({tolerance:"pointer",accept:function(t){return t.closest(".stash-sidebar").length>0},over:function(){Writer.setActive(e),e.restore_selection()},drop:function(t,i){e.remember_selection(),e.insert_thumb(i.draggable)}}),this.history.bindEvents(),this.$node.data("writer",this),this.$node.on("click.writer",this.onClick.bind(this)),this.$node.on("blur.writer",this.onBlur.bind(this)),this.$node.on("paste.writer",this.onPaste.bind(this)),this.$node.on("drop.writer",this.onDrop.bind(this)),this.$node.on("cut.writer",this.onCut.bind(this)),this.$node.on("keyup.writer",this.onKeyUp.bind(this)),this.$node.on("change.writer",this.onChange.bind(this)),this.$textarea.on("blur.writer",this.onBlur.bind(this)),this.$textarea.on("keyup.writer",this.onKeyUp.bind(this)),this.$node.on("click.writer","a",function(t){t.preventDefault()}),this.$node.on("keydown.writer",function(t){if(!(this.autocomplete&&this.autocomplete.isShown()||this.tag_autocomplete&&this.tag_autocomplete.isShown())){var e=t.metaKey||t.ctrlKey||t.altKey||t.shiftKey;69!==t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?13!=t.which||e?9!=t.which||this.options.passthrough_tab?190!=t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?32!=t.which||!t.ctrlKey||t.metaKey||t.altKey||t.shiftKey?8!=t.which||e?86==t.which&&(t.metaKey||t.ctrlKey||t.altKey)&&t.shiftKey?(ddt.log("writer","suppressing paste formatting"),this.prevent_paste_formatting=!0):this.options.block_sidescroll&&WriterUtils.blockSidescroll(this.$node[0],t):WriterUtils.killEmptyBlockquoteOnBackspace()&&t.preventDefault():(t.preventDefault(),this.removeFormatting()):(t.preventDefault(),t.stopPropagation(),PubSub.publish("WriterSidebar.show_emoticons")):e?!t.shiftKey||t.metaKey||t.ctrlKey||t.altKey||(t.preventDefault(),this.outdent()):(t.preventDefault(),this.indent()):WriterUtils.splitBlockquoteAtCursor()&&t.preventDefault():(t.preventDefault(),t.stopPropagation(),this.switchToHtmlMode())}}.bind(this)).on("keypress.writer",function(t){var e=t.metaKey||t.ctrlKey||t.altKey||t.shiftKey;13==t.which&&!e&&this.insertNewline()&&t.preventDefault()}.bind(this)),this.$textarea.on("keydown.writer",function(t){69!==t.which||!t.metaKey&&!t.ctrlKey||t.altKey||t.shiftKey?this.options.passthrough_tab||9!==t.which||t.metaKey||t.ctrlKey||t.altKey||t.shiftKey||(t.preventDefault(),WriterUtils.insertIntoTextareaAtCursor(t.target,"&nbsp; &nbsp; ")):(t.preventDefault(),t.stopPropagation(),this.switchToRichMode())}.bind(this)),this.autocomplete=new DAutoCompleteUsers(this.$node,this.options.autocomplete_priority),this.tag_autocomplete=new DAutoCompleteTags(this.$node),this.link_editor=new LinkEditor(this.$node),this.options.content&&this.$textarea.val(this.options.content),this.options.content_id&&(this.loadContent(this.options.content_id),this.options.content_id=!1),Writer.setActive(this);for(var i in this.toolbars)this.toolbars[i].rebind()},is_empty:function(){return 0===this.$node.find("img").length&&this.storage.is_empty()},update_placeholder:function(){this.is_empty()&&(this.options.placeholder_if_focused||this.$node[0]!=document.activeElement)&&this.visible?(this.$node.addClass("empty"),this.$textarea.addClass("empty")):(this.$node.removeClass("empty"),this.$textarea.removeClass("empty"))},toggle:function(t){this.visible?this.hide(t):this.show(t)},show:function(t){this.visible=!0,this.$node.prop("contentEditable",!0).show(),this.$textarea.hide(),document.queryCommandSupported("styleWithCSS")&&document.execCommand("styleWithCSS",!1,!1),t&&this.syncer.sync(!0),$.each(this.toolbars,function(t,e){e.show()}),this.update_placeholder()},hide:function(t){this.visible=!1,this.image_controls.hide(!0),this.$node.hide(),this.$textarea.show(),t&&(this.syncer.sync(),this.saveContent()),$.each(this.toolbars,function(){tollbar.hide()}),this.update_placeholder()},inRichMode:function(){return"rich"==this.editingMode},inHtmlMode:function(){return"html"==this.editingMode},switchToHtmlModeWithoutSync:function(){return this.options.allow_html_mode?(this.editingMode="html",this.image_controls.hide(!0),this.$node.hide(),this.$textarea.show().focus(),this.options.on_switch_editing_mode(),!0):!1},switchToHtmlMode:function(){this.switchToHtmlModeWithoutSync()&&(this.syncer.sync(),this.saveContent())},switchToRichMode:function(){this.editingMode="rich",this.$textarea.hide(),this.$node.show(),this.$node.focus(),this.syncer.sync(!0),this.options.on_switch_editing_mode(),this.move_caret_to_end()},enforceRichMode:function(){if(this.inRichMode())return!0;if(!this._modal){var t=this._modal=Modals.factory("<div class='pppp'>This feature is only available in Rich Editing mode. Would you like to switch to it?</div>",{showCloseButton:!1,showButtonsSeparator:!1});t.addButton("No"),t.addButton("Yes","smbutton-green",function(){Writer.getActive().switchToRichMode(),Modals.pop("ok")})}return Modals.topModal()!=this._modal&&Modals.push(this._modal),!1},insert:function(t){return this.enforceRichMode()?(this.beginEdit("insert_html"),this._insert_into_selection(t),this.scheduleSync(),this):void 0},insert_thumb:function(t){var e=Writer.getActive(),i=$(t).attr("collect_rid").split(":");switch(i[2]=i[2]||"",i[0]){case 23:case"23":case 36:case"36":case"portfolio":e.insert($("<img>",{"class":"portfoliofile gr-shrink",id:i[1],src:$(t).find("a.thumb").data("super-img")}));break;case"bing":e.insert($("<img>",{"class":"portfoliofile gr-shrink",src:$(t).attr("data-fullsize")}));break;default:var s={type:"deviation",id:i[1],format:e.insert_thumbs?e.insert_thumb_format||"thumb":"auto"},n=!e.insert_thumbs;("emote"==i[0]||"emote"==i[2])&&(s.type="emoticon",s.format="thumb",1==i[0]&&(s.profile="deviation"),n=!1),e.insert([WriterEmbed.loaderFromAttrs(s),n?"<br><br>":"&nbsp;"]),WriterEmbed.runLoaders(e.$node)}},setFocusAfter:function(t){if(window.getSelection){var e=window.getSelection(),i=document.createRange();i.setStartAfter(t),e.removeAllRanges(),e.addRange(i),this.has_focus()||this.$node.focus()}},_insert_into_selection:function(t){t=$("<div>").html(t)[0];var e=t.lastChild;if(this.restore_selection(),this.has_focus()){var i=this.get_selection();for(i.deleteContents();t.lastChild;)i.insertNode(t.lastChild);i.setStartAfter(e),window.getSelection().removeAllRanges(),window.getSelection().addRange(i),this.remember_selection()}else this.$node.append(t.childNodes)},has_focus:function(){return this.$node[0]==document.activeElement},get_selection:function(){var t=window.getSelection();return this.has_focus()&&t.rangeCount?t.getRangeAt(0):void 0},remember_selection:function(){this._selection=this.get_selection()||this._selection},restore_selection:function(){this.inRichMode()&&!this.has_focus()&&(this._selection?(window.getSelection().removeAllRanges(),window.getSelection().addRange(this._selection)):this.move_caret_to_end(),this.has_focus()||this.$node.focus())},get_textarea_selection:function(){var t=this.$textarea[0];return{start:t.selectionStart,end:t.selectionEnd,scrollTop:t.scrollTop}},restore_textarea_selection:function(t){var e=this.$textarea[0];e.selectionStart=t.start,e.selectionEnd=t.end,e.scrollTop=t.scrollTop},move_caret_to_end:function(){if(this.inRichMode()){var t=window.getSelection(),e=document.createRange();e.selectNodeContents(this.$node[0]),e.collapse(!1),t.removeAllRanges(),t.addRange(e),this.has_focus()||this.$node.focus(),this.remember_selection()}},removeFormatting:function(){this.beginEdit(),document.execCommand("removeFormat",!1,null);try{var t,e="h1,h2,h3,h4,h5,h6,blockquote,pre",i=this.get_selection();0===i.startOffset&&i.commonAncestorContainer.nodeName.match(/^h\d$/i)&&""+i===$(i.commonAncestorContainer).text()?(t=$(i.commonAncestorContainer).find(e).replaceWith(function(){return this.innerHTML}).end().html(),$(i.commonAncestorContainer).replaceWith(t)):(t=i.extractContents(),$(t.querySelectorAll(e)).replaceWith(function(){return this.innerHTML}),i.insertNode(t))}catch(s){}this.endEdit()},align:function(t){if(this.beginEdit("align"),this.restore_selection(),Browser.isIE){var e=window.getSelection(),i=e.getRangeAt(0);if($(i.commonAncestorContainer).closest("div, p").is(this.$node)){var s=$("<div>").html(i.extractContents());i.insertNode(s[0]),i.selectNodeContents(s[0]),e.addRange(i)}}document.execCommand("justify"+t,!1,null),Browser.isKHTML&&this.$node.find("*:not(.writer-embed, .writer-embed *)").each(function(){this.style.textAlign&&(this.align=this.style.textAlign,this.style.textAlign="",""===this.getAttribute("style")&&this.removeAttribute("style"))}),this.endEdit()},insertNewline:function(){if(!window.getSelection().rangeCount)return!1;var t=window.getSelection(),e=t.getRangeAt(0),i=this.$node,s=$([e.commonAncestorContainer].concat($(e.commonAncestorContainer).parentsUntil(i).toArray())),n=$(e.startContainer).closest("li");if(n.length&&WriterUtils.isVisuallyEmpty(n)){var o=n.closest("ul, ol");e.deleteContents(),n.remove(),e.setEndAfter(o[0]);var r=e.extractContents();WriterUtils.isVisuallyEmpty(r)||o.after(r);var a=document.createElement("br");return o.after(a),WriterUtils.isVisuallyEmpty(o[0])&&o.remove(),e.setStartBefore(a),t.removeAllRanges(),t.addRange(e),!0}if(n.length)return!1;if(Browser.isFirefox&&!s.is("p, :header"))return!1;var h=s.filter("a, :header").last();return h.length?this._splitNodeByRange(h[0],e):this._insertBrIntoRange(e),!0},_splitNodeByRange:function(t,e){e.deleteContents();var i="block"==$(t).css("display"),s=function(){var i=document.createRange();i.selectNode(t),i.setEnd(e.startContainer,e.startOffset);var s=i.cloneContents();return WriterUtils.isVisuallyEmpty(s)?null:s}(),n=function(){var i=document.createRange();i.selectNode(t),i.setStart(e.endContainer,e.endOffset);var s=i.cloneContents();return WriterUtils.isVisuallyEmpty(s)?null:s}();if(s&&n){var o=n.firstChild;$(t).replaceWith([s,i?null:"<br>",n]),e.selectNodeContents(o),e.collapse(!0),WriterUtils.selectRange(e)}else n?(e.setStartBefore(t),e.collapse(!0),this._insertBrIntoRange(e),e.selectNodeContents(t),e.collapse(!0),WriterUtils.selectRange(e)):(i&&$(t).is(":empty")&&$(t).html("<br>"),e.setStartAfter(t),this._insertBrIntoRange(e),i&&(e.selectNode(t),e.collapse(!1),WriterUtils.selectRange(e)))},_insertBrIntoRange:function(t){var e=this.$node,i=$("<br>").hide();t.deleteContents(),t.insertNode(i[0]),e.wrapInner("<div>");var s=e.children(":first"),n=s.height();i.removeAttr("style");var o=s.height();if(s.children(":first").unwrap(),(0===n||o==n)&&i.after("<br>"),Browser.isIE){var r=i[0].nextSibling;r&&r.nodeType==Node.TEXT_NODE&&(r.nodeValue=r.nodeValue.replace(/^[ \t\r\n]+/,""))}t.selectNode(i[0]),t.collapse(!1),WriterUtils.selectRange(t)},insertUnorderedList:function(){this._insertList(!1)},insertOrderedList:function(){this._insertList(!0)},_insertList:function(t){var e=t?"InsertOrderedList":"InsertUnorderedList";if(!Browser.isIE)return this.beginEdit(),document.execCommand(e,!1),this.endEdit(),void 0;var i=window.getSelection();if(i.rangeCount){var s=i.getRangeAt(0),n=$("<div/>").append(s.cloneContents());if(!($(s.commonAncestorContainer).closest("ul, ol").length>0||n.find("ul, ol").length)){this.beginEdit(),n.find("br").replaceWith("<div/>"),s.deleteContents(),s.insertNode(n[0]),i.removeAllRanges(),i.addRange(s),document.execCommand(e,!1);var o=$(s.endContainer).closest("ul, ol");o.find("li:empty").remove(),$(o[0].nextSibling).filter("br").remove(),o.is(":empty")&&(o.append("<li>"),i.removeAllRanges(),s.selectNodeContents(o[0].firstChild),i.addRange(s)),this.endEdit()}}},toggleBlockquote:function(){this.restore_selection();var t=window.getSelection(),e=t.getRangeAt(0),i=$(e.commonAncestorContainer).closest("blockquote");if(this.beginEdit(),i.length)if(WriterUtils.isVisuallyEmpty(i[0]))i.replaceWith("<br>");else{var s=i[0].firstChild,n=i[0].lastChild;i.append("<br>").contents().unwrap(),e=document.createRange(),e.setStartBefore(s),e.setEndAfter(n),WriterUtils.selectRange(e)}else{var o=document.execCommand("formatBlock",!1,"<blockquote>");if(!o){var r=$("<blockquote>").html(e.extractContents());e.insertNode(r[0]),e.selectNodeContents(r[0]),r.is(":empty")&&r.html("<br>"),WriterUtils.selectRange(e)}}this.endEdit()},setHeadingSize:function(t){if(!Browser.isIE)return this.beginEdit(),document.execCommand("formatBlock",!1,"<"+(t?"h"+t:"div")+">"),this.endEdit(),void 0;var e=window.getSelection();if(e.rangeCount){var i=e.getRangeAt(0),s="h1, h2, h3, h4, h5, h6",n=i.cloneContents();if(!$("<div>").html(n).find(s).length){this.beginEdit();var o=$(i.commonAncestorContainer).closest(s);if(o.length?(i.selectNodeContents(o[0]),n=i.extractContents(),i.selectNode(o[0]),i.deleteContents()):n=i.extractContents(),t>0){var r=$("<h"+t+">").append(n);i.insertNode(r[0]),i.selectNodeContents(r[0])}else for(;n.lastChild;)i.insertNode(n.lastChild);e.addRange(i),this.endEdit()}}},addLink:function(t,e){e=$.trim(e)||t.replace(/^(.{30}).+$/,"$1…"),this.restore_selection();var i=this.get_selection(),s=$(i.commonAncestorContainer).closest("a");if(s.length)e!=s.text()&&(s.text(e),this.setFocusAfter(s[0])),s.attr("href",t);else{var n=$.trim(""+i);if(n!=e){i.deleteContents();var o=$("<a />").prop("href",t).text(e)[0];i.insertNode(o),i.selectNode(o),WriterUtils.selectRange(i)}else document.execCommand("createLink",!1,t)}this.update_all_links()},frame:function(t,e){var i,s=$("<iframe>",{src:t,css:{background:"white",position:"fixed",top:"100%",left:0,"z-index":1e3,width:"100%",height:"100%",border:"0px solid black"}}).appendTo("body"),n={$:s,act:function(t){this["do_"+t]&&this["do_"+t]()},do_show:function(){s.focus().animate({top:"0%"},400),this.hidden=!1},do_hide:function(){s.animate({top:"100%"},400),this.hidden=!0},do_remove:function(){$(window).off("message.writer",r),this.do_hide(),s.promise().done(function(){s.remove()})}};i=setTimeout(function(){s.remove()},6e4),e||(e=function(t){switch(t.action){case"ready":return"show";case"done":return"remove"}});var o=(t.match(/^(https?:\/\/[^\/]+)/)||[])[1],r=function(t){if(t.originalEvent.origin!==o)return console.log("skipping postmessage because of origin",t.originalEvent.origin,o),void 0;t.originalEvent.source!=s[0].contentWindow&&console.log("skipping postmessage because of exact frame match",t.target,s[0].contentWindow),i&&(i=clearTimeout(i));var r=e(t.originalEvent.data,n);n.act(r)}.bind(this);$(window).on("message.writer",r)},indent:function(){this.beginEdit("indent"),WriterUtils.isCursorInBeginningOfListItem()?document.execCommand("indent",!1):this._insert_into_selection("&nbsp; &nbsp;&nbsp;"),this.endEdit()},outdent:function(){WriterUtils.isCursorInBeginningOfListItem()&&(this.beginEdit("outdent"),document.execCommand("outdent",!1),this.endEdit())},update_link_style:function(t){var e=$(t);e.toggleClass("external",Boolean(!Browser.isIE&&!PHP.isSafeURL(e.attr("href"))&&$.trim(e.text())&&!e.closest(".writer-embed").length));var i=e.parents(".username-with-symbol");i.length&&i.replaceWith(WriterUtils.usernameLinkToPlainText(i.html()))},update_all_links:function(){var t=this;this.$node.find("a").each(function(){t.update_link_style(this)})}},{_active:null,getActive:function(){return this._active},setActive:function(t){this._active=t},deactivateAll:function(){this._active=null},DefaultStorage:WriterStorage,DefaultSyncer:WriterSyncer,NoSaveStorage:WriterStorageNoSave,DraftHandler:Base.extend({constructor:function(t){this.writer=t},do_new:function(){this.writer.storage.clear(),this.writer.setContent("")},do_save:function(){this.writer.is_empty()||this.writer.sync()},force_save:function(){var t=this.writer.saveContent(!0);return this.writer.update_placeholder(),PubSub.publish("Writer.sync",t),t},do_load:function(t){this.writer.loadContent(t)}})}),$(document).on("keydown",function(t){!Writer.getActive()||8!=t.which||$(t.target).is("input, textarea")||t.target.isContentEditable||t.preventDefault()}),$(document).on("mousedown mouseup",function(){Writer.getActive()&&Writer.getActive().remember_selection()}),PubSub.subscribe({eventname:"WriterSidebar.cancel_interaction",subscriber:"Writer",callback:function(){Writer.getActive()&&Writer.getActive().restore_selection()}}),window.DWait&&DWait.run("jms/lib/writer/writer.js")});
DWait.ready(["jms/pages/skin_edit_base.js","jms/chrome/autobob.js","jms/lib/pager.js","jms/lib/browser.js","jms/lib/php.js","jms/lib/difi.js","jms/lib/Base.js","jms/lib/pubsub.js","jms/lib/spinpreset.js","jms/lib/writer/writer.js","jms/lib/jquery/jquery.current.js","jms/lib/bind.js","jms/pages/subby.js"],function(){window.WriterSkinbar=SkinEditBase.extend({default_skin:-39,default_options:{sections:["history","groups"],initial_selection:"history",height_drop:202},handlers:{preview_skin:function(i,s){this.options.preview(s)},display_skin:function(i,s){var t=+s.id||this.default_skin;if(s.refresh){var e=this.modes.history;e.reset(),e.fetch_callback=function(){this.sidebar.click_callback(this.$stream.find('[collect_rid="33:'+t+'"]'),s.override)}.bind(e),e.display(!0)}else this.click_callback(this.modes.history.$main.find('[collect_rid="33:'+t+'"]'),s.override)},resize:function(){var i=this.options.height_drop;this.$.find(".types-main").css("height","").height($(window).height()-i),this.$.find(".scroll-container.inner-scroll").height($(window).height()-i-72)}},constructor:function(i,s,t){this.options=$.extend(!0,{},this.default_options,t),this.$=$(i),this.$.append(['<div class="types-container">','<div class="types-overview"><ul></ul></div>','<div class="types-main"><div class="types-main-inside">','<div id="stashwriter_sidebar_skins" style="height:100%;margin:0">','<div class="skins-content"></div>',"</div>","</div></div>","</div>"].join("\n")),this.click_callback=s,this.temporary_skin=0,this.modes={};for(var a=0;this.options.sections.length>a;a++)this.modes[this.options.sections[a]]=new e[this.options.sections[a]](this);this.$.find(".types-overview ul").append(['<li class="edit-skin-item">','<span class="a edit-skin" href="#edit-skin">Edit skin</span>',"</li>"].join("\n")),this.$.find(".edit-skin").click(this.editSkin.bind(this)),this.$.find(".apply-skin").remove(),this.$.keydown(function(i){27==i.keyCode&&(i.preventDefault(),i.stopPropagation(),Writer.getActive().restore_selection())}.bind(this));var n=new Spinner(SpinnerPresets.green);this.$.data("spinner",n);var r=this;PubSub.subscribe([{eventname:"SkinEditModal.preview",subscriber:r,callback:this.handlers.preview_skin}]),PubSub.subscribe([{eventname:"SkinEditModal.display",subscriber:r,callback:this.handlers.display_skin}]),PubSub.subscribe([{eventname:"Skinbar.resize",subscriber:r,callback:this.handlers.resize}]),PubSub.publish("Skinbar.resize")},destroy:function(){PubSub.unsubscribe([{eventname:"SkinEditModal.preview",subscriber:this},{eventname:"SkinEditModal.display",subscriber:this},{eventname:"Skinbar.resize",subscriber:this}]),this.$.remove(),this.$=null},display:function(i){i=i||this.options.initial_selection,this.modes[i]&&(this.top(),this.modes[i].display())},top:function(){this.active&&this.active.close(!0)},editSkin:function(i){i.preventDefault(),i.stopPropagation(),PubSub.publish("SkinEditModal.show",{show_apply:!1})},back_click:function(i){i.preventDefault(),i.stopPropagation(),$("#stashwriter_sidebar_skins_container .types-back").click()},applySkin:function(){this.temporary_skin&&(this.temporary_skin=0,this.$.find(".apply-skin").addClass("disabled"))},setHistoryHighlight:function(i){i=i||this.default_skin,this.modes.history.initial_highlight=i,this.modes.history.fetched&&this.modes.history.$main.find('[collect_rid="33:'+i+'"]').addClass("active")}});var i=Base.extend({fetched:!1,fetch_callback:null,initial_highlight:null,constructor:function(i){this.sidebar=i,this.$item=this.render_list_item(),this.$main=this.render_main().hide(),this.$stream=this.$main.find(".stream"),i.$.find(".types-overview ul").append(this.$item),i.$.find(".skins-content").append(this.$main),this.bind()},type_name:function(){return this.name||this.label.toLowerCase().replace(/[^a-z_\-]/g,"")},render_list_item:function(){var i=$("<li>",{"class":"writer-skinbar-type-"+this.type_name(),html:"<span>"+this.label+"</span>"}).data("sidebar-type",this);return i},render_main:function(){var i=$(['<div class="scroll-container writer-skinbar-main-'+this.type_name()+'">','<div class="status"><div class="inner"><b></b><span></span></div></div>','<div class="stream stash-stream skins-stream"></div>',"</div>"].join("\n")).data("sidebar-type",this);return i},status:function(i,s,t){clearTimeout(this.status_show_timeout),clearTimeout(this.status_hide_timeout),this.status_show_timeout=setTimeout(function(){var t=this.$main.find(".status");t.find("span").html(i),s?(this.spinner=this.spinner||new Spinner($.extend({},SpinnerPresets.green,{left:0,top:0})),this.spinner.spin(t.find("b")[0])):this.spinner&&this.spinner.stop(),t.show()}.bind(this),300),t&&(this.status_hide_timeout=setTimeout($.proxy(this,"hide_status"),2e3))},hide_status:function(){clearTimeout(this.status_show_timeout),clearTimeout(this.status_hide_timeout),this.$main.find(".status").hide(),this.spinner&&this.spinner.stop()},reset:function(){this.fetched=!1,this.fetch_callback=null},display:function(){this.sidebar.active&&this.sidebar.active.close(!0),this.sidebar.active=this,this.sidebar.$.find(".types-overview li").removeClass("active"),this.$item.addClass("active"),this.sidebar.$.find('div[class^="writer-skinbar-main-"]').hide(),this.$main.show(),this.$main.find(".scroll-container.inner-scroll").length&&this.$main.find(".scroll-container.inner-scroll").css({height:this.$main.height()-67+"px",width:"auto"})},close:function(){return this.sidebar.active=!1,this.sidebar.$.find(".types-overview li").removeClass("active"),this.$main.hide(),!0},bind:function(){this.$item.click(this.item_click.bind(this)),this.$main.delegate(".stream div.resource-skin","click",this.stream_click.bind(this)).delegate(".stream div.resource-skin","dragstart",function(){return!1}),this.$main.find(".more .smbutton").click(this.more_click.bind(this))},item_click:function(i){i.preventDefault(),this.display()},stream_click:function(i){i.preventDefault(),this.initial_highlight=null;var s=$(i.target).closest("[collect_rid]");return s.hasClass("fakeskin")?!1:(this.sidebar.$.find(".apply-skin").removeClass("disabled"),this.sidebar.click_callback(s),void 0)},more_click:function(i){return i.preventDefault(),!1},skinstream:function(i,s,t){if(s=s||!1,this.$stream.empty(),s&&$('<div class="tt-a stash-tt-a resource-skin" collect_rid="33:'+this.sidebar.default_skin+'"><span class="tt-w"><span class="shadow"><a title="None" href="'+document.location.protocol+'//www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="50" width="50" src="//st.deviantart.net/minish/submit/stashwriter-noskin-1.png?55"></a></span></span><a class="t" title="None">No skin</a></div>').appendTo(this.$stream).hover(function(){var i=$(this).find("img");i.attr("src",i.attr("src").replace("noskin-1.png","noskin-2.png"))},function(){var i=$(this).find("img");i.attr("src",i.attr("src").replace("noskin-2.png","noskin-1.png"))}),s&&!window.deviantART.deviant.subbed){var e=Subby.getPremiumCheckoutUrl("writersidebarskins"),a=window.DaGa.generate_link_tracking_code("PremiumUpsell","Journal"),n="Core Members",r="get Journal Skins. Become a Core Member!",o=$('<a class="core-upsell-button" href="'+e+'" data-quicktip-title="'+n+'" '+a+' data-quicktip-text="'+r+'" onmouseover="if (window.QuickTip)QuickTip.show(this, \'subby\')"></a>');o.append('<span class="new-icon-premium-badge mark-large"></span>'),$(this.$stream).parent().prepend($('<div class="upsell-container-skin"></div>').append(o)),0===i.length&&($('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621126" deviationid="126465413"><span class="tt-w"><span class="shadow"><a class="thumb" title="Fella Journalskin v3" href="33:9621126"><img src="https://th08.deviantart.net/fs49/150/i/2009/184/a/1/Fella_Journalskin_v3_by_mindfuckx.png" width="72" height="150"></a></span><a class="t">Fella Journalskin v3</a><small class="l">by `<a class="u" href="'+document.location.protocol+'//janvanlysebettens.deviantart.com/">janvanlysebettens</a></small></span></div>').appendTo(this.$stream),$('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621125" deviationid="281111648"><span class="tt-w"><span class="shadow"><a class="thumb" title="Notebook - Journal Skin" href="33:9621125"><img src="https://th05.deviantart.net/fs70/150/i/2012/023/1/4/notebook___journal_skin_by_detrans-d4nd74w.png" width="129" height="150"></a></span><a class="t">Notebook - Journal Skin</a><small class="l">by *<a class="u" href="'+document.location.protocol+'//detrans.deviantart.com/">detrans</a></small></span></div>').appendTo(this.$stream),$('<div class="tt-a resource-skin stash-tt-a fakeskin" collect_rid="33:9621124" deviationid="190645175"><span class="tt-w"><span class="shadow"><a class="thumb" title="Air Mail" href="33:9621124"><img src="https://th08.deviantart.net/fs70/150/i/2012/264/8/7/air_mail_by_ikue-d35i6rb.png" width="128" height="150"></a></span><a class="t">Air Mail</a><small class="l">by $<a class="u" href="'+document.location.protocol+'//ikue.deviantart.com/">Ikue</a></small></span></div>').appendTo(this.$stream))}if(t)for(var h=i.length-1;h>=0;h--){var d=$(i[h][2]);d.find("a.thumb").attr("href",document.location.protocol+"//www.deviantart.com/deviation/"+d.attr("deviationid")),d.addClass("resource-skin stash-tt-a").appendTo(this.$stream)}else for(var h=0;i.length>h;h++){var d=$(i[h][2]);d.find("a.thumb").attr("href",document.location.protocol+"//www.deviantart.com/deviation/"+d.attr("deviationid")),d.addClass("resource-skin stash-tt-a").appendTo(this.$stream)}},fetch:function(i){this.status("Loading",!0),DiFi.pushPrivateGet("Stash","get_skins",[i],this.loaded_stream.bind(this)),DiFi.send()},fix_stream_size:function(){this.$stream.parent().is(".zoom-fix")||this.$stream.wrap('<div class="zoom-fix" style="width: 410px; overflow: hidden;"></div>'),this.$stream.height()&&this.$stream.parent().height(.666666*this.$stream.height()+20)},reset_stream_size:function(){this.$main.find(".zoom-fix").css("height","")}}),s=i.extend({label:"Groups",constructor:function(i){this.base(i),this._load_groups()},render_main:function(){var i=$('<div class="scroll-container writer-skinbar-main-'+this.type_name()+'">'+'<div class="status"><div class="inner"><b></b><span></span></div></div>'+'<div class="group-list"></div>'+'<div class="group-header">'+'<div class="types-back"><span>Back</span></div>'+'<div class="types-heading"></div>'+"</div>"+'<div class="stream stash-stream skins-stream"></div>'+"</div>").data("sidebar-type",this);return i},bind:function(){var i=this;this.base(),this.$main.find(".group-list").on("click",".group-item",function(){i._open_group($(this))}),this.$main.find(".group-header .types-back").on("click",function(){i._close_group()})},loaded_stream:function(i,s){return i?(this.hide_status(),this.skinstream(s.response.content),this.$stream.find("[collect_rid]").data("authorid",this._$active_group.data("userid")),this.fix_stream_size(),void 0):(this.status("Unable to load skins.",!1,!0),void 0)},_load_groups:function(){this.status("Loading",!0),DiFi.pushPost("Stash","get_groups_having_skins",[],function(i,s){if(!i)return this.status("Unable to load groups.",!1,!1),void 0;this.hide_status();var t=$.map(s.response.content.groups,function(i){return $('<div class="group-item">').data(i).html(PHP.userlink(i.username,"#","/",!0)).get(0)});t.length?this.$main.find(".group-list").append(t):this.$item.hide()}.bind(this)),DiFi.send()},_open_group:function(i){this._$active_group=i,this.$main.find(".group-list").hide(),this.$main.find(".group-header .types-heading").html(PHP.userlink(i.data("username"),"#","/",!0)),this.$main.find(".group-header").show(),this.$stream.empty().show(),this.fetch(i.data("username"))},_close_group:function(){this._$active_group=null,this.$main.find(".group-header").hide(),this.$stream.empty(),this.reset_stream_size(),this.$main.find(".group-list").show()}}),t=i.extend({label:"Installed",display:function(i){i=i||!1,i||this.base(),this.fetched||this.fetch(deviantART.deviant.username)},loaded_stream:function(i,s){return i?(this.fetched=!0,this.hide_status(),this.skinstream(s.response.content,!0,!0),this.fix_stream_size(),this.fetch_callback&&this.fetch_callback(),this.initial_highlight&&this.highlight_skin(this.initial_highlight),void 0):(this.status("Unable to load skins.",!1,!0),void 0)},highlight_skin:function(i){var s=this.$main.find('[collect_rid="33:'+i+'"]');s.addClass("active"),s.length&&i>0&&this.sidebar.$.find(".skins-content").scrollTop((s.position().top-10)*(Browser.isKHTML?.666667:1))}}),e={groups:s,history:t};window.DWait&&DWait.run("jms/lib/writer/skinbar.js")});
DWait.ready(["jms/lib/jquery/jquery.current.js","jms/lib/writer/utils.js"],function(){function t(t){function e(e,n){if(t.contains(e)||t.contains(e.parentNode)){if(3==e.nodeType)for(var i=e;(i=i.previousSibling)&&3==i.nodeType;)n+=i.nodeValue.length;for(var r=n;e&&e!=t;e=e.parentNode){for(var i,o=0;i=e.previousSibling;e=i)o+=3==e.nodeType&&3==i.nodeType?0:1;r=o+","+r}return r}}var n=window.getSelection();if(n.rangeCount)var i=n.getRangeAt(0),r=e(i.startContainer,i.startOffset),o=e(i.endContainer,i.endOffset);return r&&o?r+"|"+o:""}function e(t,e){function n(t){for(var n=e,i=0;t.length-1>i;i++)n=n.childNodes[t[i]];return n}if(t){var i=t.split("|")[0].split(","),r=t.split("|")[1].split(",");t=window.getSelection();var o=document.createRange();try{return o.setStart(n(i),i.pop()),o.setEnd(n(r),r.pop()),t.removeAllRanges(),t.addRange(o),!0}catch(s){return!1}}}WriterUndo=function(t){this.writer=t,$.extend(this.writer,this.writerMixin),this._undoStack=[],this._redoStack=[],this._currentEdit=null,this._lastSnapshot=null,this._onAfterKeyboardInput=null,this._onAfterKeyboardInputTimeout=null,this._lastKeyEvent=null,this._lastKeyDownEvent=null,this.bindEvents()},WriterUndo.prototype.canUndo=function(){return this._undoStack.length>0},WriterUndo.prototype.canRedo=function(){return this._redoStack.length>0},WriterUndo.prototype.undo=function(){if(this.endEdit(),this.canUndo()){var t=this._undoStack.pop();this._redoStack.push(t),this._lastSnapshot=t.before,this.writer.restoreSnapshot(t.before)}},WriterUndo.prototype.redo=function(){if(this.canRedo()&&this.endEdit(),this.canRedo()){var t=this._redoStack.pop();this._undoStack.push(t),this._lastSnapshot=t.after,this.writer.restoreSnapshot(t.after)}},WriterUndo.prototype.bindEvents=function(){this.writer.$node.off(".writer-undo").on({"keydown.writer-undo":$.proxy(this,"onKeyDown"),"keypress.writer-undo":$.proxy(this,"onKeyPress")})},WriterUndo.prototype.onKeyDown=function(t){if("keydown"==t.type){var e=t;this._lastKeyDownEvent=t,this._lastKeyEvent=t}else var e=this._lastKeyDownEvent;var n=8,i=46,r=89,o=90,s=e.which,h=e.metaKey||e.ctrlKey,a=e.shiftKey,d=e.altKey;s!=o||!h||a||d?s==r&&h&&!a&&!d||s==o&&h&&a&&!d?(this.redo(),t.preventDefault(),t.actedUpon=!0):s==i?(this.onKeyboardInput("forward_delete"),t.actedUpon=!0):s==n&&(this.onKeyboardInput("backward_delete"),t.actedUpon=!0):(this.undo(),t.preventDefault(),t.actedUpon=!0)},WriterUndo.prototype.onKeyPress=function(t){var e=this._lastKeyEvent,n=this._lastKeyDownEvent;if(this._lastKeyEvent=t,!t.metaKey&&!t.ctrlKey||88!=t.which&&118!=t.which){e&&n&&t.type==e.type&&t.which==e.which&&t.shiftKey==e.shiftKey&&t.metaKey==e.metaKey&&t.ctrlKey==e.ctrlKey&&this.onKeyDown(t);var i=e&&"keydown"==e.type&&e.actedUpon||t.actedUpon;t.which&&!i&&this.onKeyboardInput("typing")}},WriterUndo.prototype.onKeyboardInput=function(t){this._onAfterKeyboardInput&&this._onAfterKeyboardInput();var e=this.writer.createSnapshot();this._onAfterKeyboardInput=$.proxy(function(){clearTimeout(this._onAfterKeyboardInputTimeout),this._onAfterKeyboardInput=null,this.beginEdit(t,e)},this),this._onAfterKeyboardInputTimeout=setTimeout(this._onAfterKeyboardInput,0)},WriterUndo.prototype.beginEdit=function(t,e){t=t||"";var n=this.writer.createSnapshot();e&&e.html==n.html||(e&&this._currentEdit&&this._currentEdit.after&&t==this._currentEdit.type&&(!this._lastSnapshot||e.html==this._lastSnapshot.html)&&e.selection==this._currentEdit.after.selection?this._currentEdit.after=n:(this.endEdit(e||n),this._currentEdit=e?{type:t,before:e,after:n}:{type:t,before:n}),this._lastSnapshot=n)},WriterUndo.prototype.endEdit=function(t){t=t||this.writer.createSnapshot(),this._currentEdit&&(this._currentEdit.after||(this._currentEdit.after=t),this._currentEdit.before.html!=this._currentEdit.after.html&&(this._undoStack.push(this._currentEdit),this._redoStack=[],this._lastSnapshot=this._currentEdit.after)),this._lastSnapshot&&t.html!=this._lastSnapshot.html&&(this._undoStack.push({type:"unknown",before:this._lastSnapshot,after:t}),this._redoStack=[]),this._currentEdit=null,this._lastSnapshot=t,this.writer.$node.trigger("writereditcomplete")},WriterUndo.prototype.writerMixin={undo:function(){this.history.undo(),this.remember_selection()},redo:function(){this.history.redo(),this.remember_selection()},beginEdit:function(t){this.history.beginEdit(t)},endEdit:function(){this.history.endEdit(),this.scheduleSync()},createSnapshot:function(){return{html:this.$node.html(),selection:this.has_focus()&&t(this.$node[0])}},restoreSnapshot:function(t){this.$node.html(t.html),e(t.selection,this.$node[0])&&WriterUtils.scrollSelectionIntoView()}},window.DWait&&DWait.run("jms/lib/writer/undo.js")});
DWait.ready(["jms/lib/spinpreset.js","jms/pages/submission.js","cssms/lib/writer.css","jms/legacy/modals.js","jms/lib/jquery/jquery.current.js","jms/lib/toolbar.js","jms/lib/gwebpage.js","jms/lib/cssvault.js","jms/lib/writer/skinbar.js","jms/pages/skin_edit_base.js","jms/lib/sidebar.js","jms/lib/writer/factory.js","jms/lib/menutraffic.js","jms/lib/difi.js","jms/lib/pubsub.js","jms/lib/writer/writer.js","jms/lib/writer/status_notifier.js","jms/lib/Base.js"],function(){(function(t){var i=Base.extend({instanceTimestamp:void 0,defaultTitle:"Untitled",defaultDraftTitle:"Untitled Draft",init:function(i){this.instanceTimestamp=Date.now(),i=i||{},this.options={deviation_id:i.deviation_id||location.hash.substring(1)||null,stackid:i.stackid||null},t("#journal_body").val(function(){return this.defaultValue}),$subtoolbar=t('<div class="stashwriter-subtoolbar"></div>').prependTo(".stashwriter-container"),t("#stashwriter_main").scroll(function(){$subtoolbar[this.scrollTop?"addClass":"removeClass"]("in-scroll")}),t("#stashwriter_sidebar").css({"background-color":"#f5f5f5"}),this.Writer=new e,this.Writer.init(this),this.Tabs=new a,this.Tabs.init(this),this.Skins=new r,this.Skins.init(this),this.Sidebar=new s,this.Sidebar.init(this),this.statusNotifier=new DeviationWriterStatusNotifier(this.Writer.writer.storage),this.statusNotifier.getFileMenu=t.proxy(this,"getFileMenu"),this.statusNotifier.getTitle=t.proxy(this,"getJournalTitle"),this.Writer.adjustHeight(),t(window).unbind("resize.stashwriter").bind("resize.stashwriter",function(){this.Writer.adjustHeight()}.bind(this)),t(".stashwriter-submit").on("click.stashwriter",function(t){t.preventDefault(),this.save()}.bind(this)),t(".stashwriter-preview, .stashwriter-preview-small").on("click.stashwriter",function(t){t.preventDefault(),this.preview()}.bind(this)),t("#stashwriter_main").on("click.stashwriter","a",function(t){t.preventDefault()}),t("#stashwriter_main").on("change.stashwriter","input",function(){this.Writer.writer.sync()}.bind(this)),t("#journal-subject").prop("tabindex",1),t("#journal_body").prop("tabindex",2),t("#stashwriter_main .stashwriter-submit").prop("tabindex",3),PubSub.subscribe([{eventname:"Signup.headerRefresh",subscriber:this,callback:function(){t.each(this.Writer.writer.toolbars,function(t,i){i.destroy()}),this.Writer.writer.createToolbars(),t.each(this.Writer.writer.toolbars,function(t,i){i.show(),i.rebind()})}.bind(this)}])},reset:function(e){e=e||{},location.hash.substr(1)!=e.deviation_id&&(location.hash=e.deviation_id||""),t("#stashwriter_main, .stashwriter-submit, .stashwriter-preview, .stashwriter-preview-small").off(".stashwriter"),t(".stashwriter-container").empty().replaceWith(t("#stash-container-clean-slate-html").text()),PubSub.unsubscribe({eventname:"Signup.headerRefresh",subscriber:this}),this.statusNotifier.destroy(),window.Writer.deactivateAll(),window.WriterFactory.destroyAll(),window.StashWriter=new i,window.StashWriter.init(e)},getJournalMetadata:function(){return{skinid:StashWriter.options.skin_id,skin_authorid:StashWriter.options.skin_authorid,fullview:t("#journal_show_as_fullview").is(":checked")}},getJournalTitle:function(){return t("#stashwriter_journal [name=subject]").val()||this.options.title||this.defaultDraftTitle},setJournalTitle:function(i){(i==this.defaultDraftTitle||i==this.defaultTitle)&&(i=""),t("#stashwriter_journal [name=subject]").val(i)},set_save_status:function(i){this.is_saving=i,this.statusNotifier.forceAlert=i,t(".stashwriter-submit").toggleClass("loading",i).find("em").text(i?"Saving...":"Done")},save:function(){var t=this.Writer.writer;if(!this.is_saving&&!t.is_empty()){this.set_save_status(!0),t.sync();var i=function(e,s){clearTimeout(this.save_timeout),t.storage.onSaveEnd.remove(i),e?this._save(t):(this.set_save_status(!1),"timeout"===s&&alert("An error occurred saving your deviation. Please try again."))}.bind(this);t.storage.onSaveEnd.add(i),this.save_timeout=setTimeout(function(){i(!1,"timeout")},15e3),t.isSaving()||i(!0)}},_save:function(t){if(!t.storage.id())return this.set_save_status(!1),t.is_empty()?void 0:this.options.deviation_id?(this.goto_deviation(this.options.deviation_id,this.options.privateid),void 0):alert("Can't save due to an error");var i=t.storage.id(),e=t.storage.id(!0);if(!this.options.deviation_id||i==this.options.deviation_id){console.log("draft had, going to",i),t.removeSavedContent();var s=this;return this.undraft(i,function(){s.goto_deviation(i,e)}),void 0}var r=this.options.deviation_id,a=this.options.privateid,n=this.options.deviation_version;DiFi.pushPost("Stash","update_journal",[r,n,this.getJournalTitle(),t.getContent(),this.getJournalMetadata()],function(s,n){if(s){var o=this;return t.skip_location_change=!0,t.removeSavedContent(!0,function(){o.goto_deviation(r,a)}),void 0}var l=n.response.content.error&&n.response.content.error.code;if("ERR_VERSION_CONFLICT"==l||"ERR_VERSION_INCREMENT"==l){if(confirm("It looks like someone else has edited this document. If you would like to keep your changes, they can be saved as a new document in your Sta.sh. Otherwise, Sta.sh Writer will now load the other author's version.\n\nWould you like to save your version as a new draft and continue working?")){t.removeSavedContent();var o=this;return this.undraft(i,function(){o.goto_deviation(i,e)}),void 0}this.set_save_status(!1),this.reset(this.options)}else this.set_save_status(!1),DiFi.stdErr("An error occurred saving your deviation. Please try again.",n.response.content)}.bind(this)),DiFi.send()},isDirty:function(){return this.Writer&&this.Writer.writer.isDirty()},_preview_window:null,_preview_timeout:null,_preview_window_name:"daWriterPreview",_open_preview_window:function(){return(!this._preview_window||this._preview_window.closed)&&(this._preview_window=popup("",this._preview_window_name,600,null,!0)),this._preview_window?(this._preview_window.document.body.innerHTML='<style>body {background: whiteSmoke; font: 27px "Trebuchet MS", Arial, sans-serif;text-align: center; padding-top: 1em;color: #939499;}</style>Loading...',this._preview_window.focus(),!0):(alert("Preview window has been blocked. Please allow for Sta.sh to open a popup window."),!1)},_load_into_preview_window:function(i,e){var s="/writer/preview/"+(i||"empty");if(e){var r=t("<form>",{method:"post",action:s,target:this._preview_window_name}).hide().appendTo("body");for(var a in e)r.append(t("<input>",{type:"hidden",name:a,value:e[a]}));r.submit().remove()}else this._preview_window.location=s;this._preview_window.focus()},preview:function(t,i){var e=this.Writer.writer,s=e.isSaving();clearTimeout(this._preview_timeout),i&&s?this._preview_timeout=setTimeout(this.preview.bind(this,t,!0),500):i&&!s?this._load_into_preview_window(e.storage.id(),t?{preview_skin:"1",skin_label:t.label,skin_head:t.head,skin_foot:t.foot,skin_css:t.css}:null):(e.sync(),this._open_preview_window()&&this.preview(t,!0))},goto_deviation:function(t,i){window.location.hash=t,window.location.href=document.location.protocol+"//sta.sh/0"+parseInt(i||t,10).toString(36)},undraft:function(t,i){var e=function(t,e){t?i&&i.call(this):DiFi.stdErr("Removing document from drafts",e.response.content)};this.options.stackid?DiFi.pushPost("Stashes","move_into",[this.options.stackid,t],e):DiFi.pushPost("Stashes","remove_from_named_stack",[t,"Drafts"],e),this.getJournalTitle()==this.defaultDraftTitle&&DiFi.pushPost("Deviation","UpdateTitle",[t,this.defaultTitle]),DiFi.send()},getFileMenu:function(){return this.Writer.writer.toolbars[0].getItem("file")}}),e=Base.extend({writerInitialized:!1,init:function(i){if(this.global=i,!this.writerInitialized){var e=[{toolbar_name:"writertop",toolbar_node:".stashwriter-toolbar",toolbar_button_class:"headerButton",toolbar_menu_class:"headerMenu gmbutton2",toolbar_popup_class:"stashwriter-toolbar-menu",toolbar_order:["undo","redo","separator","file","edit"]}];e.push({toolbar_name:"writersub",toolbar_node:".stashwriter-subtoolbar",toolbar_button_class:"subToolbarButton",toolbar_menu_class:"subToolbarMenu",toolbar_popup_class:"stashwriter-subtoolbar-menu stashwriter-subtoolbar-menu",toolbar_order:["bold","italic","underline","headings","separator","ul","ol","blockquote","separator","alignl","alignc","alignr","separator","link","zoom"]});var s=Writer.DraftHandler.extend({do_load:function(t){this.do_save(),i.reset({deviation_id:t})},do_new:function(){this.do_save(),i.reset()}}),r={content_id:this.global.options.deviation_id,content:"",toolbars:e,draft_metadata:this.global.getJournalMetadata.bind(this.global),draft_title:this.global.getJournalTitle.bind(this.global),draft_handler:s,on_load_content:function(i){this.global.options.deviation_id=i.id,this.global.options.title=i.title,this.global.options.deviation_version=i.version,this.global.setJournalTitle(i.title),this.global.Skins.get({id:Number(i.skin.itemid),authorid:Number(i.skin.userid)}),this.loadEditingMode(),t("#journal_show_as_fullview").prop("checked",i.metadata.fullview),t(".stashwriter_actions .ile-shorturl input").val(i.short_url),t(".stashwriter-container").css("visibility","visible")}.bind(this),on_load_error:function(t){DiFi.stdErr(null,t),this.global.reset()}.bind(this),on_save_content:function(i){window.location.hash=i.stashid,t(".stashwriter_actions .ile-shorturl input").val(i.short_url),this.saveEditingMode()}.bind(this),on_remove_content:function(){this.writer.skip_location_change||(window.location.hash=""),t(".stashwriter_actions .ile-shorturl input").val("")}.bind(this),on_switch_editing_mode:function(){this.adjustHeight(),this.saveEditingMode()}.bind(this),storage:vms_feature("qunit")?"NoSaveStorage":"DefaultStorage",valid_tags:["br","hr","strong","b","code","sub","sup","small","tt","acronym","a","abbr","strike","em","i","u","ins","span","blockquote","p","bcode","ul","ol","dl","pre","li","cut","div","da:embed","da:deviation","da:thumb","da:bigthumb","da:widget","da:emoticon","da:drawing","img","font","h1","h2","h3","h4","h5","h6"],valid_attrs:["align","alt","class","height","href","id","name","skinscript","src","title","width","target","data-.+"]};"$"==window.deviantART.deviant.symbol&&r.valid_tags.push("table","tbody","tr","td"),this.writer=WriterFactory.toggle("journal_body",r),this.writer.options.content_id||t(".stashwriter-container").css("visibility","visible"),this.writerInitialized=!0,Writer.getActive().$node.focus(),Writer.getActive().$node.prop("tabindex",2),t("body").unbind("click.writer_focus").bind("click.writer_focus",function(i){if(!Writer.getActive().has_focus()){var e=".headerButton, .subToolbarButton, .popup2, #stashwriter_sidebar, .stashwriter_actions, input, div.writer, textarea",s="#stashwriter_sidebar .writer-sidebar-main-emoticons li";t(i.target).closest(s).length?Writer.getActive().restore_selection():t(i.target).closest(e).length||Writer.getActive().restore_selection()}})}},adjustHeight:function(){var i=Writer.getActive().inRichMode()?Writer.getActive().$node:Writer.getActive().$textarea,e=t("#stashwriter_main").height()-t("#stashwriter_main_inner").height()-2+i.height();i.css("min-height",e)},loadEditingMode:function(){var t=this.writer.storage.id();if(t){var i="stashwriter-editing-mode-"+t;localStorage.getItem(i)&&this.writer.switchToHtmlModeWithoutSync()}},saveEditingMode:function(){var t=this.writer.storage.id();if(t){var i="stashwriter-editing-mode-"+t;this.writer.inHtmlMode()?localStorage.setItem(i,1):localStorage.removeItem(i)}}}),s=Base.extend({init:function(i){this.global=i,this.sidebar=new WriterSidebar("#stashwriter_sidebar_files",function(t){this.global.Writer.writer.insert_thumb(t)}.bind(this),{drop_zone:t("body"),initial_selection:"stash",upload_thumb:!0})}}),r=SkinEditBase.extend({counter:0,fetched:!1,init:function(i){this.global=i,this.skinbar=new WriterSkinbar("#stashwriter_sidebar_skins_container",function(i,e){return i.hasClass("resource-noskin")?(this.remove(),this.global.Writer.adjustHeight(),void 0):(t(".skin-title").text(i.find(".thumb").attr("title")),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.get({id:parseInt(i.attr("collect_rid").split(":")[1],10),authorid:i.data("authorid")||0},e),i.addClass("active"),void 0)}.bind(this),{preview:function(t){StashWriter.preview(t)}}),t("#stashwriter_sidebar_skins_container").hide()},show:function(){this.skinbar.display()},remove:function(){this.global.options.skin_id&&(Writer.setActive(this.global.Writer.writer),t("#stashwriter_sidebar_skins .skin-title").text("None"),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.skin_data_to(t("#stashwriter_main .journal-skin-editor"),{jheader:"",jfooter:"",jcss:"",skinid:"",authorid:"",label:""}),this.save_skin(null))},callback:function(i,e){this.fetched=!0;var s=t("#stashwriter_sidebar_skins .stream");if(s.html(""),!i)return s.html("Unable to load skins."),void 0;var r=e.response.content.resources;if(0===r.length)return s.html("No skins found."),void 0;t('<div class="tt-a stash-tt-a resource-skin" collect_rid="33:-39"><span class="tt-w"><span class="shadow"><a title="None" href="'+document.location.protocol+'//www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="50" width="50" src="//st.deviantart.net/minish/submit/stashwriter-noskin-1.png?55"></a></span></span><a class="t" title="None">Remove skin</a></div>').appendTo(s).hover(function(){var i=t(this).find("img");i.attr("src",i.attr("src").replace("noskin-1.png","noskin-2.png"))},function(){var i=t(this).find("img");i.attr("src",i.attr("src").replace("noskin-2.png","noskin-1.png"))});for(var a=0;r.length>a;a++)t(r[a][2]).addClass("resource-skin").addClass("stash-tt-a").appendTo(s);t('<div class="tt-aa resource-skin browse-link"><span class="tt-ww"><span class="shadow"><a class="skinthumb" href="'+document.location.protocol+'//www.deviantart.com/darelated/deviantartskin/journalcss/journal/" target="_blank"><img height="52" width="52" src="//st.deviantart.net/minish/gruzecontrol/browse-skins.png"></a></span></span></div>').addClass("tt-a").appendTo(s);var n=t(".skin-title");if(this.global.options.skin_id){var o=s.find('div.resource-skin[collect_rid="33:'+this.global.options.skin_id+'"]');o.addClass("active"),n.text(o.find(".skinthumb").attr("title")),s.find('div.resource-skin[collect_rid="33:'+this.global.options.skin_id+'"]').addClass("active")}else n.text("None")},click:function(i){return i.hasClass("resource-noskin")?(this.remove(),this.global.Writer.adjustHeight(),void 0):i.hasClass("browse-link")?window.open(i.closest(".browse-link").find("a").attr("href")):(t(".skin-title").text(i.find("a.t").attr("title")),t("#stashwriter_sidebar_skins .stream").find(".active").removeClass("active"),this.get({id:parseInt(i.attr("collect_rid").split(":")[1],10),authorid:i.data("authorid")||0}),i.addClass("active"),void 0)},get:function(i,e){if(this.global.instanceTimestamp===window.StashWriter.instanceTimestamp){var s=this;if(s.counter++,!i.id)return this.remove(),void 0;DiFi.pushPost("Journal","get_styled_edit_form_user",[i.authorid,i.id,s.counter,e||{}],function(i,e){if(!i)return DiFi.stdErr("Skin loading",e.response.content);CSSVault.free("journal-skinny-"+(s.counter-1)),CSSVault.apply("journal-skinny-"+s.counter,e.response.content.css);var r,a,n,o;Writer.getActive()?(n=Writer.getActive().inHtmlMode(),n&&(o=Writer.getActive().get_textarea_selection()),r=Writer.getActive().getContent(),a=Writer.getActive().$node.data()):(r=t("#journal_body").val(),a=t("#journal_body").data());var l=this.global.getJournalTitle();(l==this.global.defaultTitle||l==this.global.defaultDraftTitle)&&(l="");var d=t("#journal_show_as_fullview").is(":checked");gWebPage.update({deps:e.response.content.deps}),t("#stashwriter_journal").empty().html(e.response.content.html).show();var h=t("#stashwriter_journal").find("[name=subject]");h.val(l),r&&t("#journal_body").val(r),t("#journal_show_as_fullview").prop("checked",d);var u=e.response.content.skin;this.skin_data_to(t("#stashwriter_main .journal-skin-editor"),u),t(".skin-title").text(u.label),this.skinbar.setHistoryHighlight(u.itemid),t("#journal_body").attr("toolbar","journal_body-writer"),this.global.Writer.writerInitialized||this.global.Writer.init(this.global);var c=Writer.getActive();c.attach(t("#journal_body"),!0),c.$node.css({height:"auto",overflow:"auto"}).parent().css({height:"auto"}),c.show(),n&&(c.switchToHtmlMode(),c.restore_textarea_selection(o)),a&&a.states&&(console.log("Setting previous toolbar states: ",a.states),c.$node.data("states",a.states));for(var _ in Toolbars)Toolbars[_].rebind();this.save_skin(u),this.global.Writer.adjustHeight()}.bind(this)),DiFi.send()}},save_skin:function(t){t&&t.itemid>0?(this.global.options.skin_id=t.itemid,this.global.options.skin_authorid=t.authorid):(this.global.options.skin_id=0,this.global.options.skin_authorid=0),this.global.options.skin=t||{};var i=this.global.Writer.writer;console.log("resetting contents after skin save"),i.saveContent()},handlers:{preview_skin:function(t,i){this.global.preview(i)},display_skin:function(t,i){this.get(i,i.override)}},editSkin:function(t){t.preventDefault(),t.stopPropagation();var i=this;PubSub.publish("SkinEditModal.show",{show_apply:!1}),PubSub.subscribe([{eventname:"SkinEditModal.preview",subscriber:i,callback:this.handlers.preview_skin}]),PubSub.subscribe([{eventname:"SkinEditModal.display",subscriber:i,callback:this.handlers.display_skin}])}}),a=Base.extend({init:function(i){this.global=i,this.activeTab="stashwriter_sidebar_files_container",t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_skins_show").click(this.showSkins.bind(this));var e=this;PubSub.subscribe([{eventname:"Skinbar.collapse",subscriber:e,callback:this.hideSkins}])},showSkins:function(i){i.preventDefault();var e=this,s=t("#stashwriter_sidebar_files .types-main").height();t("#stashwriter_sidebar_files").addClass("sidebar-collapsed"),t("#stashwriter_sidebar_files .types-main").animate({height:"0px"},"fast",function(){e.global.Sidebar.sidebar.top()}),t("#stashwriter_sidebar_files_container .current-skin").hide(),t("#stashwriter_sidebar_skins_container").show().find(".types-main").css("height","0px").animate({height:s+"px"},"fast"),t("#stashwriter_sidebar_skins").show(),e.global.Skins.show()},hideSkins:function(i,e){this.global.Skins.skinbar.applySkin(),t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_skins").hide(),t("#stashwriter_sidebar_files_container").show(),t("#stashwriter_sidebar_files").show();var s=this,r=t("#stashwriter_sidebar_skins_container .types-main").height();t("#stashwriter_sidebar_files").removeClass("sidebar-collapsed"),s.global.Sidebar.sidebar.modes[e].display(),t("#stashwriter_sidebar_files .types-main").animate({height:r+"px"},"fast"),t("#stashwriter_sidebar_skins_container .types-main").animate({height:r+"px"},"fast",function(){t("#stashwriter_sidebar_skins_container").hide(),t("#stashwriter_sidebar_files_container .current-skin").show()})}});window.StashWriter=new i,t(window).on("beforeunload",function(){return!StashWriter.is_saving&&StashWriter.isDirty()?"Your draft hasn't been saved yet.":void 0})})(jQuery),window.DWait&&DWait.run("jms/pages/submit/StashWriter.js")});if(window.DWait){DWait.count()}