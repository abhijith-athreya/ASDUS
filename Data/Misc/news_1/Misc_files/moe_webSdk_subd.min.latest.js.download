function getCurrentPermissionState(){return new Promise(function(a){a(localStorage.getItem("moe_push_storage")?{state:"granted",token:localStorage.getItem("moe_push_storage")}:"DENY"===localStorage.getItem("MOE_ACCEPTED")?{state:"denied",token:null}:{state:"prompt",token:null})})}function performIntegrationChecks(){try{return new Promise(function(a,b){var c,d,e,f={},g=new Promise(function(a,b){c=a}),h=new Promise(function(a,b){d=a}),i=new Promise(function(a,b){e=a}),j=JSON.parse(localStorage.getItem("moengage_collected_data")),k="serviceworker.js";j&&j.serviceworker_file&&(k=j.serviceworker_file);var l=window.location.href;"/"!=l[l.length-1]&&(l=l.substring(0,l.lastIndexOf("/")+1)),fetch(l+k).then(function(a){200!=a.status?f.serviceworker_present=!1:f.serviceworker_present=!0,c()},function(a){f.serviceworker_present=!1,c()});var m=l+"manifest.json";fetch(m).then(function(a){200!=a.status?(f.manifest_present=!1,f.manifest_sender_id="",e()):(f.manifest_present=!0,a.json().then(function(a){a&&a.gcm_sender_id?f.manifest_sender_id=a.gcm_sender_id:f.manifest_sender_id="",e()},function(a){f.manifest_sender_id="",e()})),d()},function(a){f.manifest_present=!1,f.manifest_sender_id="",e(),d()});var n=!1,o=document.head.getElementsByTagName("link");Array.prototype.forEach.call(o,function(a){a.href==m&&(n=!0)}),f.manifest_included_in_head=!!n,g.then(function(){return h}).then(function(){return i}).then(function(){a(f)})})}catch(a){console.log("EXCEPTION- INTEGRATION CHECKS- ",a)}}function registerServieWorker(){var a=JSON.parse(localStorage.getItem("moengage_collected_data")),b="serviceworker.js";return a&&a.serviceworker_file&&(b=a.serviceworker_file),new Promise(function(a,c){"serviceWorker"in navigator?navigator.serviceWorker.register(b,{scope:"./"}).then(function(){a()},function(a){c()}):(console.log("Servie Worker Not Supported"),c())})}function forceOptIn(){"default"==Notification.permission?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_SHOWN"},"*"),Notification.requestPermission(function(a){"default"==a?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_DISMISSED"},"*"),forceOptIn()):processOptIn(a)})):processOptIn(Notification.permission)}function processOptIn(a){var b=new CustomEvent("MOE_OPTIN_UPDATE",{detail:a}),c=new CustomEvent("MOE_OPTIN_UPDATE_COMPLETE",{detail:a});window.dispatchEvent(b),"granted"==a?(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_ALLOWED"},"*"),updatePushToken().then(function(){window.opener&&window.opener.postMessage({type:"MOE_CONVENTIONAL_OPT_IN"},"*"),window.dispatchEvent(c)})):"denied"==a&&(window.opener&&window.opener.postMessage({type:"MOE_OPT_IN_BLOCKED"},"*"),localStorage.setItem("MOE_ACCEPTED","DENY"),window.dispatchEvent(c))}function refreshTokenByPopup(){var a=localStorage.getItem("MOE_OPENED_ONCE_SETUP"),b=new Date,c=b.getTime()-864e5*moePopupRefreshInterval;a&&parseInt(a)<c&&localStorage.removeItem("MOE_OPENED_ONCE"),a||"yes"!=localStorage.getItem("MOE_OPENED_ONCE")||localStorage.setItem("MOE_OPENED_ONCE_SETUP",b.getTime())}function updatePushToken(){if("granted"==Notification.permission&&self===top)return registerServieWorker().then(function(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:!0})}).then(function(a){var b=JSON.parse(JSON.stringify(a)),c=b.endpoint.split("/");if(c.pop(),b.endpoint=c.join("/")+"/",b.keys){for(var d in b.keys)b.keys.hasOwnProperty(d)&&(b["keys_"+d]=b.keys[d]);delete b.keys}localStorage.setItem("moe_push_endpoint",JSON.stringify(b));var e=a.endpoint.split("/"),f=e[e.length-1];localStorage.setItem("moe_push_storage",f),dataToServiceWorker=JSON.parse(localStorage.getItem("moengage_collected_data")),dataToServiceWorker.push_id=f;try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker")}})});self===top&&"denied"===Notification.permission&&localStorage.setItem("MOE_ACCEPTED","DENY")}var moeSubscribeUserSwap,moeUnSubscribeUserSwap,moeCheckPushSubscriptionStatus,moeLoadBanner,moeRemoveBanner,moeOpenSubDomain,moeCloseBanner,moePopupRefreshInterval=30,createObjFromURI=function(){for(var a=decodeURI(location.search.substr(1)),b=a.split("&"),c=Object(),d=0;d<b.length;d++){var e=b[d].split("=");-1!==e[0].search("\\[\\]")?void 0===c[e[0]]?c[e[0]]=[e[1]]:c[e[0]].push(e[1]):c[e[0]]=e[1]}return c},dataToServiceWorker=createObjFromURI();void 0==dataToServiceWorker[""]&&delete dataToServiceWorker[""];var baseDomainName="https://websdk.moengage.com",debug_mode=0,initialize=0,sdk_version="3.0",userStructure={user_attr:{},event_queue:[],user_attr_queue:[],device_add:!1};Notification||(Notification={permission:"denied",requestPermission:function(){return"denied"}});var listener=function(a){if("get_push_token"==a.data){token=localStorage.getItem("moe_push_storage"),f={type:"get_push_token",token:token};var b=localStorage.getItem("moe_push_endpoint");b&&(f.endpoint=b),a.source.postMessage(f,a.origin)}else if("opened_once"==a.data)token=localStorage.getItem("MOE_OPENED_ONCE"),f={type:"opened_once",token:token},a.source.postMessage(f,a.origin);else if("ask_for_notification"==a.data)Notification.requestPermission(function(b){return"denied"===b?(token="DENY",f={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","DENY"),a.source.postMessage(f,a.origin),void console.log("Permission wasn't granted. Allow a retry.")):"default"===b?(token="PROMPT",f={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","PROMPT"),a.source.postMessage(f,a.origin),void console.log("The permission request was dismissed.")):(token="ACCEPT",f={type:"ask_for_notification",token:token},localStorage.setItem("MOE_ACCEPTED","ACCEPT"),void a.source.postMessage(f,a.origin))});else if("is_already_accepted"==a.data)getCurrentPermissionState().then(function(b){f={type:"is_already_accepted",token:b},a.source.postMessage(f,a.origin)});else if("moengage_data_from_frame"==a.data){token=localStorage.getItem("moengage_data_subdomain");var c=localStorage.getItem("moe_push_storage"),b=localStorage.getItem("moe_push_endpoint"),d=localStorage.getItem("MOE_PUSH_ENDPOINT");localStorage.getItem("MOE_PUSH_TOKEN");f={type:"moengage_data_from_frame",token:token,push:c},b&&(f.endpoint=b),d&&(f.endpoint2=d),a.source.postMessage(f,a.origin)}else if("destroy_session"==a.data)destroySession(),token="destroy_session_subdomain",f={type:"destroy_session",token:token},a.source.postMessage(f,a.origin);else if(a.data&&"moengage_data_to_frame"==a.data.type){temp=a.data.token,temp2=a.data.collect_data,temp2&&localStorage.setItem("moengage_collected_data",JSON.stringify(temp2)),localStorage.setItem("moengage_data_subdomain",JSON.stringify(temp));try{var e=a.data.collect_data;e&&e.unique_id&&e.app_id}catch(a){}}else if(a.data&&"moengage_assist_integration_checks"==a.data.type)performIntegrationChecks().then(function(b){var c={type:"moengage_assist_integration_checks",token:b};a.source.postMessage(c,a.origin)});else if(a.data&&"moengage_remove_expired_token"==a.data.type){localStorage.removeItem("moe_push_storage"),localStorage.removeItem("moe_push_endpoint");var f={type:"moengage_remove_expired_token",token:"DONE"};a.source.postMessage(f,a.origin)}},destroySession=function(){localStorage.removeItem("moeWebSDKSettings"),localStorage.removeItem("MOE_ACCEPTED"),localStorage.removeItem("moeWebSDKSettingsSetupTime"),localStorage.removeItem("moengage_data"),localStorage.removeItem("moengage_data_subdomain"),localStorage.removeItem("moe-ftl"),localStorage.removeItem("ask_web_push"),localStorage.removeItem("MOE_LAST_PROMPT"),localStorage.removeItem("MOE_OPENED_ONCE"),localStorage.removeItem("SOFT_LOAD")},resetToken=function(){getCurrentPermissionState().then(function(a){"granted"!==a.state&&localStorage.removeItem("moe_push_storage")})};resetToken();var guid=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return debug_mode&&console.log("Generating new unique_id"),a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},first_event_queue=0,first_user_attr_queue=0,clearQueue_counter=0,retry_limit=5,subscriptionId,isIncognitoFlag,sBrowser,sUsrAg=navigator.userAgent;-1!=navigator.userAgent.indexOf("MSIE")||1==!!document.documentMode?(sBrowser="Internet Explorer",console.log("Browser not supported.")):sUsrAg.indexOf("Edge")>-1?sBrowser="Edge":sUsrAg.indexOf("OPR")>-1||sUsrAg.indexOf("Opera")>-1?sBrowser="Opera":sUsrAg.indexOf("Chrome")>-1?(sBrowser="Google Chrome",sUsrAg.indexOf("MMS")>-1&&(sBrowser="Opera Neon")):sBrowser=sUsrAg.indexOf("Safari")>-1?"Apple Safari":sUsrAg.indexOf("Firefox")>-1?"Mozilla Firefox":"Others";var makePost=function(a,b,c,d){var e=new XMLHttpRequest;a=constructGet(a,b),e.open("POST",a,!0),e.onreadystatechange=function(){4==e.readyState&&d&&d(e.responseText,e.status)},e.send(JSON.stringify(c))},constructGet=function(a,b){a+="?";for(var c in b)a+=c+"="+b[c]+"&";return a},set_item=function(a){try{window.location.search.replace("?","");localStorage.setItem("moengage_data",JSON.stringify(a))}catch(a){debug_mode&&console.log("Cannot set Item",a)}},track_event=function(a,b,c){},add_user_attribute=function(a,b,c){},collectData=function(){var a=new Date;Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds());return promise=new Promise(function(a){get_params=dataToServiceWorker,get_params.push_id=subscriptionId||"NA",a(get_params)}),promise},webPushFunctions=function(a){var b=function(a,b){return new Promise(function(c,d){if(dataToServiceWorker.unique_id){var e=localStorage.getItem("moe_push_storage");if(!a){subscriptionId=null,"unsubscribed"==b?track_event("MOE_USER_UNSUBSCRIBED",{MOE_WEB_PUSH_TOKEN:"NA"}):void 0==b&&"null"!=e&&track_event("MOE_USER_SUBSCRIPTION_CHECK",{MOE_WEB_PUSH_TOKEN:"NA"}),localStorage.setItem("moe_push_storage",null),dataToServiceWorker.push_id=subscriptionId;try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker (null scenario)")}return void c()}endpointSections=a.endpoint.split("/"),subscriptionId=endpointSections[endpointSections.length-1],dataToServiceWorker.push_id=subscriptionId,"subscribed"==b?(add_user_attribute("Web Push Preference","granted"),localStorage.setItem("moe_push_storage",subscriptionId),track_event("MOE_USER_SUBSCRIBED",{MOE_WEB_PUSH_TOKEN:subscriptionId},"hide")):void 0==b&&e!=subscriptionId&&(add_user_attribute("Web Push Preference","granted"),track_event("MOE_USER_SUBSCRIPTION_CHECK",{MOE_WEB_PUSH_TOKEN:subscriptionId}),localStorage.setItem("moe_push_storage",subscriptionId));try{navigator.serviceWorker.controller.postMessage({data:dataToServiceWorker})}catch(a){console.log("data not sent to serviceWorker")}c()}else d("Unique ID null")})},c=function(){return new Promise(function(a,c){navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:!0})}).then(function(d){b(d,"subscribed").then(function(){a()},function(a){c(a)})}).catch(function(a){return c("Subscription Failed"),"Subscription Failed"})})},d=function(){"serviceWorker"in navigator&&("Google Chrome"==sBrowser||"Mozilla Firefox"==sBrowser||"Opera"==sBrowser||"Opera Neon"==sBrowser)&&navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){var d=document.getElementById("subscribing");if(d||console.log("subscribing span missing"),!a)return void b(null).then(function(){setTimeout(function(){window.opener&&window.opener.postMessage({type:"subscription_timeout"},"*"),window.close()},1e4),c().then(function(){d&&(d.innerHTML="Subscribed!!"),setTimeout(function(){window.close()},500)},function(a){d&&(d.innerHTML="Unsuccessful!!"),setTimeout(function(){},500),console.log(a)})});b(a).then(function(){setTimeout(function(){window.opener&&window.opener.postMessage({type:"subscription_timeout"},"*"),window.close()},1e4),d&&(d.innerHTML="Subscribed!!"),setTimeout(function(){window.close()},500)},function(a){d&&(d.innerHTML="Unsuccessful!!"),setTimeout(function(){window.opener&&window.opener.postMessage({type:"MOE_NEVER_ASK"},"*"),window.close()},5e3),console.log(a)})}).catch(function(a){})};registerServieWorker().then(d)};window.addEventListener("message",listener,!1);var gets=window.location.search.replace("?","");if(gets.length>0){localStorage.setItem("MOE_OPENED_ONCE","yes");var a=new Date;localStorage.setItem("MOE_OPENED_ONCE_SETUP",a.getTime()),gets.indexOf("conventional")>-1?(localStorage.setItem("MOE_CONVENTIONAL_OPT_IN","true"),forceOptIn()):webPushFunctions()}updatePushToken();