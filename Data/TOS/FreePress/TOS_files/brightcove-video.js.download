define(["jquery","underscore","baseview","pubsub","state","admanager","adLogger","utils","cookie"],function(e,i,t,o,d,s,n,a){"use strict";var r=t.extend({events:{"click .videoStillPlay":"swapImageForVideo","click .videoStill":"swapImageForVideo","click .videoCloseButton":"hidePlayer"},initialize:function(a){a=e.extend({live:!1,onVideoComplete:null,onVideoShow:null,onVideoHide:null,onVideoLoaded:null},a),this.$videoObj=this.$(".videoObject"),this.$brightcove=this.$(".BrightcoveExperience"),this.brightcoveId=this.$(".BrightcoveExperience").attr("id"),this.playerHTML=this.$videoObj.html();var r=this.$videoObj.data()||{},l=((e.cookie("aamusat")||"").match(/[0-9]+/g)||[]).join(","),h=e.cookie("aam_uuid"),c="";this.pageinfo=d.getActivePageInfo(),this.pageinfo.series&&(c+="&series="+encodeURIComponent(this.pageinfo.series)),this.pageinfo.topic&&(c+="&topic="+encodeURIComponent(this.pageinfo.topic)),this.pageinfo.basePageType&&(c+="&pagetype="+encodeURIComponent(this.pageinfo.basePageType)),c+="&aam="+l+"&u="+h,n.logInfo("Built ad call for video, "+r.id+".",this.pageinfo,r);var v="https://pubads.g.doubleclick.net/gampad/ads?env=vp&gdfp_req=1&impl=s&output=xml_vast2&iu="+s.buildAdUnit("preroll_video")+"/"+r.cst+"&sz=920x508&unviewed_position_start=1&cust_params=contentid%3D"+r.brightcovevideoid+encodeURIComponent(c)+'&cmsid=12768&url=""';n.logInfo("Video Ad call: "+v),e("<param>",{name:"adServerURL",value:v}).appendTo(this.$(".BrightcoveExperience")),this.$videoObj.length&&this.brightcoveId&&(i.bindAll(this,"createPlayer","onBrightCoveLoad","onTemplateReady","onVideoComplete","onVideoStart","isPlayingHandler","determineCompletion"),this.throttledDetermine=i.throttle(this.determineCompletion,1500),t.prototype.initialize.call(this,a),(this.options.autostart||this.$videoObj.attr("data-autoplay"))&&this.createPlayer(),this._buildBrightCoveLoadCallback(),this._buildBrightCoveReadyCallback(),this.pubSub={"pause:videos":this.pauseVideo},o.attach(this.pubSub,this))},_buildBrightCoveLoadCallback:function(){window.BCCallbacks||(window.BCCallbacks={}),window.BCCallbacks[this.brightcoveId]=this.onBrightCoveLoad,window.BCLoad||(window.BCLoad=i.bind(function(e){this._triggerNeon("onTemplateLoad",e),window.BCCallbacks[e]?window.BCCallbacks[e](e):console.log("received brightcove callback for video that does not exist: "+e)},this))},_buildBrightCoveReadyCallback:function(){window.BCReady||(window.BCReady=i.bind(function(e){this._triggerNeon("onTemplateReady",e)},this))},_neonEnabled:function(){return a.getNested(window.site_vars,"flags","neon")&&window.NeonPlayerTracker},_triggerNeon:function(e,t){this._neonEnabled()&&i.isFunction(window.NeonPlayerTracker[e])&&window.NeonPlayerTracker[e](t)},onBrightCoveLoad:function(e){this.$(".temp-loader").fadeOut(),this.player=window.brightcove.api.getExperience(e),this.APIModules=window.brightcove.api.modules.APIModules,this.player?(console.log("brightcove loaded successfully",this.brightcoveId),this.options.onVideoLoaded&&this.options.onVideoLoaded(this.brightcoveId),this.modVP=this.player.getModule(this.APIModules.VIDEO_PLAYER),this.modCon=this.player.getModule(this.APIModules.CONTENT),this.modExp=this.player.getModule(this.APIModules.EXPERIENCE),this.modExp.addEventListener(window.brightcove.api.events.ExperienceEvent.TEMPLATE_READY,this.onTemplateReady)):console.warn("brightcove video loaded, but could not get experience: "+e)},onTemplateReady:function(e){this.modVP&&(this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.BEGIN,this.onVideoStart),this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.COMPLETE,this.onVideoComplete),this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.PLAY,this.onMediaEventFired),this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.STOP,this.onMediaEventFired),this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.SEEK_NOTIFY,this.onMediaEventFired),this.modVP.addEventListener(window.brightcove.api.events.MediaEvent.PROGRESS,this.throttledDetermine))},onVideoStart:function(e){var i=this.getVideoDetail();e.duration<0?i.videoDuration="":e.duration<120?i.videoDuration="less than 2 min":i.videoDuration="greater than 2 min",i.completion="0%",i.liveVideoSubject?i.videoName=i.liveVideoSubject:i.videoName=e.media.displayName,i.eventtype="video:load",i.contentid=e.target.experience.id,i.videoFulllengthUrl=e.media.FLVFullLengthURL,"undefined"!=typeof i.assetid&&e.media.referenceId!==i.assetid.toString()&&(i.assetid=e.media.referenceId,i.ssts=e.media.customFields.gdp_ssts||i.ssts,i.cst=e.media.customFields.gdp_cst||i.cst,i.videocontentprovider=e.media.customFields.gannetttracking+"|"+e.media.displayName,i.keywords=e.media.customFields.gdp_tags||i.keywords,"undefined"!=typeof e.media.customFields.gdp_canonical_url&&(i.pathName=e.media.customFields.gdp_canonical_url.replace(/^.*\/\/[^\/]+/,"")),i=this.setVideoDetailMeta(i)),o.trigger("video:load",i)},onVideoComplete:function(){console.log("video playback finished: "+this.brightcoveId),e.isFunction(this.options.onVideoComplete)&&this.options.onVideoComplete()},onMediaEventFired:function(e){o.trigger("uotrack",e.type)},determineCompletion:function(e){var i=e.duration,t=e.position,d=Math.round(t/i*100),s=this.$videoObj.data().videourl;!this.fiftypercent&&d>=50&&95>d?(o.trigger("vitrack",{percentage:"50%",video_url:s}),this.fiftypercent=!0):!this.ninetyfivepercent&&d>=95&&99>d&&(o.trigger("vitrack",{percentage:"95%",video_url:s}),this.ninetyfivepercent=!0)},createPlayer:function(){if(window.brightcove){var e=this.$brightcove;e.params={forceHTML:!1},window.brightcove.createExperiencesPostLoad=function(){},window.brightcove.createExperiences(null,this.brightcoveId),d.stopRefreshTimer(),this.$videoObj.show()}else this.loadScripts(this.createPlayer)},destroy:function(e,o){if(d.startRefreshTimer(),this.brightcoveId&&window.brightcove&&(this.player||window.brightcove.api&&(this.player=window.brightcove.api.getExperience(this.brightcoveId)),this.player&&(this.modVP||(this.modVP=this.player.getModule(window.brightcove.api.modules.APIModules.VIDEO_PLAYER)),this.modVP&&this.resetVideoState()),window.brightcove&&(window.brightcove.experiences&&delete window.brightcove.experiences[this.brightcoveId],window.brightcove.instances&&delete window.brightcove.instances[this.brightcoveId])),window.BCCallbacks){if(window.BCCallbacks[this.brightcoveId]&&delete window.BCCallbacks[this.brightcoveId],0===i.size(window.BCCallbacks)){window.BCCallbacks=void 0,window.BCLoad=void 0,window.BCReady=void 0;try{delete window.BCCallbacks,delete window.BCLoad,delete window.BCReady}catch(s){}}}else console.warn("BCCallbacks no longer available on video destroy");t.prototype.destroy.apply(this,arguments)},resetVideoState:function(){this.player&&(this.modVP&&(this.pauseVideo(),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.BEGIN,this.onVideoStart),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.COMPLETE,this.onVideoComplete),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.PLAY,this.onMediaEventFired),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.STOP,this.onMediaEventFired),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.SEEK_NOTIFY,this.onMediaEventFired),this.modVP.removeEventListener(window.brightcove.api.events.MediaEvent.PROGRESS,this.throttledDetermine),this.modVP=!1,this.modCon=!1,this.modExp=!1),this.player=!1),this.$(".videoStill, .videoStillPlay").show(),this.$videoObj.html(this.playerHTML),this.hidePlayer()},hidePlayer:function(){this.$videoObj&&this.$videoObj.hide(),this.options.onVideoHide&&this.options.onVideoHide(),d.startRefreshTimer()},loadScripts:function(e){require(["https://sadmin.brightcove.com/js/BrightcoveExperiences.js"],function(){"undefined"!=typeof window.brightcove?(console.log("Brightcove loaded"),e()):console.log("Error loading Brightcove")})},swapImageForVideo:function(e){this.createPlayer(),this.options.onVideoShow&&this.options.onVideoShow(),this.$(".videoStill, .videoStillPlay").hide(),this.$(".temp-loader").show(),o.trigger("video:playClick")},getVideoDetail:function(){var e=this.$videoObj.data()||{};return e.pathName="",e.liveVideoSubject?e.pathName=e.liveVideoSubject:e.videourl&&(e.pathName=e.videourl.replace(/^.*\/\/[^\/]+/,"")),this.setVideoDetailMeta(e)},setVideoDetailMeta:function(e){try{e.cst||(e.cstlist=e.cst.split("/"),e.category=e.cstlist[0],e.cst=e.cstlist.slice(0,3).join(":"),e.subcategory=e.cstlist.slice(0,2).join(":")),e.sstslist||(e.sstslist=e.ssts.split("/"),e.section=e.sstslist[0],e.ssts=e.sstslist.join(":"),e.subsection=e.sstslist.slice(0,2).join(":"),e.topic=e.sstslist.slice(0,3).join(":"))}catch(i){return void console.error("Invalid page",i.stack||i.stacktrace||i.message)}return e},pauseVideo:function(){void 0!==this.modVP&&this.modVP.pause(!0)},isPlayingHandler:function(e){this.options.live||e&&this.modVP.pause(!0)},loadVideoById:function(e){this.modVP.loadVideoByID(e)}});return r});
//# sourceMappingURL=brightcove-video.js.map